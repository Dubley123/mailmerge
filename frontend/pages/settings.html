<!-- ç³»ç»Ÿè®¾ç½®é¡µé¢ -->
<!-- å¼•å…¥ç³»ç»Ÿè®¾ç½®ä¸“ç”¨æ ·å¼ -->
<link rel="stylesheet" href="/frontend/static/css/settings.css?v=d8aa0046">

<div class="settings-page">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="settings-header">
        <h2 class="settings-title">ç³»ç»Ÿè®¾ç½®</h2>
        <p class="settings-subtitle">ç®¡ç†æ‚¨çš„ä¸ªäººè´¦æˆ·ä¿¡æ¯å’Œå¯†ç </p>
    </div>

    <!-- è®¾ç½®å¡ç‰‡å®¹å™¨ -->
    <div class="settings-container">
        <!-- ä¸ªäººä¿¡æ¯å¡ç‰‡ï¼ˆå±•ç¤ºæ¨¡å¼ï¼‰ -->
        <div class="settings-card">
            <div class="card-header">
                <div class="header-left">
                    <h3 class="card-title">ğŸ‘¤ ä¸ªäººä¿¡æ¯</h3>
                    <p class="card-description">æŸ¥çœ‹å’Œä¿®æ”¹æ‚¨çš„åŸºæœ¬ä¿¡æ¯</p>
                </div>
                <div class="header-action">
                    <button type="button" class="btn btn-primary" id="editProfileBtn">
                        <span>âœï¸ ä¿®æ”¹</span>
                    </button>
                </div>
            </div>
            
            <div class="info-display" id="profileDisplay">
                <!-- ä¿¡æ¯é¡¹å°†é€šè¿‡ JavaScript åŠ¨æ€åŠ è½½ -->
            </div>
        </div>

        <!-- ä¿®æ”¹å¯†ç å¡ç‰‡ -->
        <div class="settings-card">
            <div class="card-header">
                <div class="header-left">
                    <h3 class="card-title">ğŸ”’ å®‰å…¨è®¾ç½®</h3>
                    <p class="card-description">ä¿®æ”¹ç™»å½•å¯†ç å’Œå®‰å…¨é€‰é¡¹</p>
                </div>
            </div>
            
            <form id="passwordForm" class="settings-form">
                <div class="form-row">
                    <div class="form-group form-group-full">
                        <label for="oldPassword" class="form-label">å½“å‰å¯†ç  <span class="required">*</span></label>
                        <input type="password" id="oldPassword" name="oldPassword" class="form-input" required placeholder="è¯·è¾“å…¥æ‚¨çš„å½“å‰å¯†ç ">
                    </div>
                </div>
                
                <div class="form-divider"></div>
                
                <div class="form-row">
                    <div class="form-group form-group-full">
                        <label for="newPassword" class="form-label">æ–°å¯†ç  <span class="required">*</span></label>
                        <div class="password-input-wrapper">
                            <input type="password" id="newPassword" name="newPassword" class="form-input" required minlength="6" placeholder="è¯·è¾“å…¥æ–°å¯†ç ï¼ˆè‡³å°‘6ä¸ªå­—ç¬¦ï¼‰">
                            <button type="button" class="password-toggle" data-target="newPassword">ğŸ‘</button>
                        </div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group form-group-full">
                        <label for="confirmPassword" class="form-label">ç¡®è®¤æ–°å¯†ç  <span class="required">*</span></label>
                        <div class="password-input-wrapper">
                            <input type="password" id="confirmPassword" name="confirmPassword" class="form-input" required placeholder="è¯·å†æ¬¡è¾“å…¥æ–°å¯†ç ">
                            <button type="button" class="password-toggle" data-target="confirmPassword">ğŸ‘</button>
                        </div>
                        <span class="form-hint" id="passwordMismatchHint" style="color: var(--danger); display: none;">âš ï¸ ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´</span>
                    </div>
                </div>
                
                <div class="password-strength" id="passwordStrength"></div>
                
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary" id="changePasswordBtn">
                        <span>ğŸ”„ ä¿®æ”¹å¯†ç </span>
                    </button>
                    <div class="form-status" id="passwordStatus"></div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ç¼–è¾‘ä¸ªäººä¿¡æ¯æ¨¡æ€æ¡† -->
<div class="modal-overlay" id="editProfileModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>ç¼–è¾‘ä¸ªäººä¿¡æ¯</h2>
            <button type="button" class="modal-close-btn" id="closeModalBtn">âœ•</button>
        </div>
        
        <form id="editProfileForm" class="modal-body">
            <div class="form-row">
                <div class="form-group form-group-half">
                    <label for="editName" class="form-label">å§“å</label>
                    <input type="text" id="editName" name="name" class="form-input" readonly>
                </div>
                
                <div class="form-group form-group-half">
                    <label for="editUsername" class="form-label">ç”¨æˆ·å <span class="required">*</span></label>
                    <input type="text" id="editUsername" name="username" class="form-input" required placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group form-group-half">
                    <label for="editAccount" class="form-label">è´¦å·</label>
                    <input type="text" id="editAccount" name="account" class="form-input" readonly>
                </div>
                
                <div class="form-group form-group-half">
                    <label for="editDepartment" class="form-label">æ‰€å±é™¢ç³»</label>
                    <input type="text" id="editDepartment" name="department" class="form-input" readonly>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group form-group-half">
                    <label for="editEmail" class="form-label">é‚®ç®± <span class="required">*</span></label>
                    <input type="email" id="editEmail" name="email" class="form-input" required placeholder="è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€">
                </div>
                
                <div class="form-group form-group-half">
                    <label for="editPhone" class="form-label">æ‰‹æœºå·</label>
                    <input type="tel" id="editPhone" name="phone" class="form-input" placeholder="è¯·è¾“å…¥æ‰‹æœºå·ç ">
                </div>
            </div>
        </form>
        
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" id="cancelEditBtn">å–æ¶ˆ</button>
            <button type="button" class="btn btn-primary" id="submitEditBtn">ä¿å­˜æ›´æ”¹</button>
        </div>
    </div>
</div>

<!-- æ¶ˆæ¯å¼¹çª— -->
<div class="message-dialog" id="messageDialog">
    <div class="message-dialog-content">
        <div class="message-dialog-header" id="messageHeader">
            <span class="message-dialog-icon" id="messageIcon"></span>
            <span id="messageTitle"></span>
        </div>
        <div class="message-dialog-body" id="messageBody"></div>
        <div class="message-dialog-footer">
            <button type="button" class="btn btn-primary" id="messageConfirmBtn">ç¡®å®š</button>
        </div>
    </div>
</div>

<script>
// æ˜¾ç¤ºæ¶ˆæ¯å¼¹çª—
function showMessageDialog(message, type = 'success', title = null) {
    const dialog = document.getElementById('messageDialog');
    const header = document.getElementById('messageHeader');
    const icon = document.getElementById('messageIcon');
    const titleEl = document.getElementById('messageTitle');
    const body = document.getElementById('messageBody');
    const confirmBtn = document.getElementById('messageConfirmBtn');
    
    // æ¸…é™¤ä¹‹å‰çš„ç±»å‹æ ·å¼
    header.classList.remove('success', 'error', 'warning');
    header.classList.add(type);
    
    // è®¾ç½®å›¾æ ‡å’Œæ ‡é¢˜
    const config = {
        success: { icon: 'âœ…', title: title || 'æˆåŠŸ' },
        error: { icon: 'âŒ', title: title || 'é”™è¯¯' },
        warning: { icon: 'âš ï¸', title: title || 'è­¦å‘Š' }
    };
    
    icon.textContent = config[type].icon;
    titleEl.textContent = config[type].title;
    body.textContent = message;
    
    // æ˜¾ç¤ºå¼¹çª—
    dialog.classList.add('active');
    
    // ç»‘å®šå…³é—­äº‹ä»¶
    const closeDialog = () => {
        dialog.classList.remove('active');
        confirmBtn.removeEventListener('click', closeDialog);
        dialog.removeEventListener('click', outsideClickHandler);
    };
    
    const outsideClickHandler = (e) => {
        if (e.target === dialog) {
            closeDialog();
        }
    };
    
    confirmBtn.addEventListener('click', closeDialog);
    dialog.addEventListener('click', outsideClickHandler);
}

// åˆå§‹åŒ–è®¾ç½®é¡µé¢
function initSettings() {
    console.log('[Settings] é¡µé¢åˆå§‹åŒ–å¼€å§‹');
    
    // åŠ è½½ç”¨æˆ·ä¿¡æ¯
    loadUserProfile();
    
    // ç»‘å®šäº‹ä»¶
    bindEditProfileEvents();
    bindPasswordFormEvents();
    bindPasswordToggle();
    bindModalEvents();
    
    console.log('[Settings] é¡µé¢åˆå§‹åŒ–å®Œæˆ');
}

// ä½¿ç”¨å¾®ä»»åŠ¡é˜Ÿåˆ—ç¡®ä¿DOMå®Œå…¨å°±ç»ª
Promise.resolve().then(() => {
    initSettings();
});

async function loadUserProfile() {
    console.log('[Settings] ç”¨æˆ·ä¿¡æ¯åŠ è½½å¼€å§‹');
    try {
        const response = await API.get('/api/auth/me');
        
        if (response.success) {
            const user = response.data.data || response.data;
            displayUserProfile(user);
            fillEditForm(user);
            console.log('[Settings] ç”¨æˆ·ä¿¡æ¯åŠ è½½å®Œæˆ');
        } else {
            showMessageDialog('åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥', 'error');
        }
    } catch (error) {
        showMessageDialog('åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•', 'error');
    }
}

function displayUserProfile(user) {
    const profileDisplay = document.getElementById('profileDisplay');
    
    if (!profileDisplay || !user) {
        profileDisplay.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">æ— æ³•åŠ è½½ç”¨æˆ·ä¿¡æ¯</div>';
        return;
    }
    
    profileDisplay.innerHTML = `
        <div class="info-item">
            <span class="info-label">å§“åï¼š</span>
            <span class="info-value">${user.name || '-'}</span>
        </div>
        <div class="info-item">
            <span class="info-label">å·¥å·ï¼š</span>
            <span class="info-value">${user.id || '-'}</span>
        </div>
        <div class="info-item">
            <span class="info-label">ç”¨æˆ·åï¼š</span>
            <span class="info-value">${user.username || '-'}</span>
        </div>
        <div class="info-item">
            <span class="info-label">è´¦å·ï¼š</span>
            <span class="info-value">${user.account || '-'}</span>
        </div>
        <div class="info-item">
            <span class="info-label">æ‰€å±é™¢ç³»ï¼š</span>
            <span class="info-value">${user.department || '-'}</span>
        </div>
        <div class="info-item">
            <span class="info-label">é‚®ç®±ï¼š</span>
            <span class="info-value">${user.email || '-'}</span>
        </div>
        <div class="info-item">
            <span class="info-label">ç”µè¯ï¼š</span>
            <span class="info-value">${user.phone || '-'}</span>
        </div>
    `;
}

function fillEditForm(user) {
    if (!user) return;
    
    const editName = document.getElementById('editName');
    const editUsername = document.getElementById('editUsername');
    const editAccount = document.getElementById('editAccount');
    const editEmail = document.getElementById('editEmail');
    const editPhone = document.getElementById('editPhone');
    const editDepartment = document.getElementById('editDepartment');
    
    if (editName) editName.value = user.name || '';
    if (editUsername) editUsername.value = user.username || '';
    if (editAccount) editAccount.value = user.account  || '';
    if (editEmail) editEmail.value = user.email || '';
    if (editPhone) editPhone.value = user.phone || '';
    if (editDepartment) editDepartment.value = user.department || '';
}

function bindEditProfileEvents() {
    const editBtn = document.getElementById('editProfileBtn');
    
    if (editBtn) {
        editBtn.addEventListener('click', function(e) {
            openEditModal();
        });
    }
}

function openEditModal() {
    const modal = document.getElementById('editProfileModal');
    if (modal) {
        modal.classList.add('active');
    }
}

function closeEditModal() {
    const modal = document.getElementById('editProfileModal');
    if (modal) {
        modal.classList.remove('active');
    }
}

function bindModalEvents() {
    // å…³é—­æŒ‰é’®
    const closeBtn = document.getElementById('closeModalBtn');
    if (closeBtn) {
        closeBtn.addEventListener('click', closeEditModal);
    }
    
    // å–æ¶ˆæŒ‰é’®
    const cancelBtn = document.getElementById('cancelEditBtn');
    if (cancelBtn) {
        cancelBtn.addEventListener('click', closeEditModal);
    }
    
    // ç‚¹å‡»è¦†ç›–å±‚å…³é—­
    const modal = document.getElementById('editProfileModal');
    if (modal) {
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                closeEditModal();
            }
        });
    }
    
    // æäº¤æŒ‰é’®
    const submitBtn = document.getElementById('submitEditBtn');
    if (submitBtn) {
        submitBtn.addEventListener('click', submitEditProfile);
    }
}

async function submitEditProfile() {
    const username = document.getElementById('editUsername').value.trim();
    const email = document.getElementById('editEmail').value.trim();
    const phone = document.getElementById('editPhone').value.trim();
    
    // éªŒè¯é‚®ç®±æ ¼å¼
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
        showMessageDialog('è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€', 'error');
        return;
    }
    
    // éªŒè¯ç”¨æˆ·å
    if (username.length === 0) {
        showMessageDialog('è¯·è¾“å…¥ç”¨æˆ·å', 'error');
        return;
    }
    
    try {
        const response = await API.put('/api/settings/profile', {
            username: username,
            email: email,
            phone: phone || null
        });
        
        if (response.success) {
            showMessageDialog('ä¸ªäººä¿¡æ¯æ›´æ–°æˆåŠŸ', 'success');

            const responseData = response.data;
            const user = responseData && (responseData.data || responseData) || null;
            if (user) displayUserProfile(user);

            const currentUser = Utils.getUser();
            if (currentUser) {
                currentUser.username = username;
                currentUser.email = email;
                currentUser.phone = phone;
                Utils.saveUser(currentUser);
                updatePageUserDisplay();
            }

            closeEditModal();
        } else {
            const errMsg = (response && (response.data?.message || response.data?.detail || response.message || response.error)) || 'æ›´æ–°å¤±è´¥';
            showMessageDialog(errMsg, 'error');
        }
    } catch (error) {
        showMessageDialog('æ›´æ–°å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
    }
}

function bindPasswordFormEvents() {
    const passwordForm = document.getElementById('passwordForm');
    if (passwordForm) {
        // å®æ—¶æ£€æŸ¥æ–°å¯†ç å¼ºåº¦
        const newPassword = document.getElementById('newPassword');
        if (newPassword) {
            newPassword.addEventListener('input', checkPasswordStrength);
        }
        
        // å®æ—¶æ£€æŸ¥å¯†ç åŒ¹é…
        const confirmPassword = document.getElementById('confirmPassword');
        const passwordMismatchHint = document.getElementById('passwordMismatchHint');
        if (confirmPassword && passwordMismatchHint) {
            confirmPassword.addEventListener('input', () => {
                const newPwd = document.getElementById('newPassword').value;
                const confirmPwd = confirmPassword.value;
                
                if (confirmPwd.length > 0 && newPwd !== confirmPwd) {
                    passwordMismatchHint.style.display = 'block';
                } else {
                    passwordMismatchHint.style.display = 'none';
                }
            });
        }
        
        // æäº¤è¡¨å•
        passwordForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const oldPassword = document.getElementById('oldPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            // éªŒè¯æ–°å¯†ç 
            if (newPassword.length < 6) {
                showMessageDialog('æ–°å¯†ç è‡³å°‘éœ€è¦6ä¸ªå­—ç¬¦', 'error');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showMessageDialog('ä¸¤æ¬¡è¾“å…¥çš„æ–°å¯†ç ä¸ä¸€è‡´', 'error');
                return;
            }
            
            if (oldPassword === newPassword) {
                showMessageDialog('æ–°å¯†ç ä¸èƒ½ä¸å½“å‰å¯†ç ç›¸åŒ', 'error');
                return;
            }
            
            try {
                const response = await API.post('/api/settings/password', {
                    old_password: oldPassword,
                    new_password: newPassword
                });
                
                if (response.success) {
                    showMessageDialog('å¯†ç ä¿®æ”¹æˆåŠŸ', 'success');
                    passwordForm.reset();
                    document.getElementById('passwordStrength').innerHTML = '';
                } else {
                    const errMsg = (response && (response.data?.message || response.data?.detail || response.message || response.error)) || 'å¯†ç ä¿®æ”¹å¤±è´¥';
                    showMessageDialog(errMsg, 'error');
                }
            } catch (error) {
                showMessageDialog('ä¿®æ”¹å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            }
        });
    }
}

function bindPasswordToggle() {
    const toggleButtons = document.querySelectorAll('.password-toggle');
    toggleButtons.forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.preventDefault();
            const targetId = btn.dataset.target;
            const input = document.getElementById(targetId);
            if (input.type === 'password') {
                input.type = 'text';
                btn.textContent = 'ğŸ‘â€ğŸ—¨';
            } else {
                input.type = 'password';
                btn.textContent = 'ğŸ‘';
            }
        });
    });
}

function checkPasswordStrength() {
    const password = document.getElementById('newPassword').value;
    const strengthContainer = document.getElementById('passwordStrength');
    
    if (!password) {
        strengthContainer.innerHTML = '';
        return;
    }
    
    let strength = 0;
    let strengthText = 'å¼±';
    let strengthColor = '#ef4444';
    
    if (password.length >= 8) strength++;
    if (/[a-z]/.test(password)) strength++;
    if (/[A-Z]/.test(password)) strength++;
    if (/[0-9]/.test(password)) strength++;
    if (/[!@#$%^&*]/.test(password)) strength++;
    
    if (strength >= 4) {
        strengthText = 'å¼º';
        strengthColor = '#10b981';
    } else if (strength >= 2) {
        strengthText = 'ä¸­ç­‰';
        strengthColor = '#f59e0b';
    }
    
    strengthContainer.innerHTML = `
        <div class="strength-bar">
            <div class="strength-fill" style="width: ${(strength / 5) * 100}%; background-color: ${strengthColor}"></div>
        </div>
        <span class="strength-text" style="color: ${strengthColor}">å¯†ç å¼ºåº¦ï¼š${strengthText}</span>
    `;
}

function updatePageUserDisplay() {
    // æ›´æ–°é¡µé¢ä¸Šçš„ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º
    const user = Utils.getUser();
    if (user) {
        // æ›´æ–°header
        const headerName = document.getElementById('headerUserName');
        if (headerName) headerName.textContent = user.name || 'ç”¨æˆ·';
        
        // æ›´æ–°sidebar
        const sidebarName = document.getElementById('sidebarUserName');
        if (sidebarName) sidebarName.textContent = user.name || 'ç”¨æˆ·';
        
        const sidebarDept = document.getElementById('sidebarUserDept');
        if (sidebarDept) sidebarDept.textContent = user.department || 'é™¢ç³»';
    }
}
</script>
