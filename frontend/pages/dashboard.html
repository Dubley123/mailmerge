<!-- 首页概览页面 -->
<link rel="stylesheet" href="/frontend/static/css/dashboard.css?v=09cb7561">

<div class="dashboard-container" id="dashboardContainer">
    <div class="dashboard-loading" id="loadingIndicator">
        正在加载数据...
    </div>
</div>

<script>
(function() {
    console.log('[Dashboard] 页面初始化开始');
    
    async function getDashboardData() {
        try {
            const result = await CommonAPI.get('/api/dashboard/overview');
            return result.success ? { success: true, data: result.data } : { success: false, message: result.message || '获取失败' };
        } catch (error) {
            return { success: false, message: '网络错误' };
        }
    }

    function renderPersonalInfo(info) {
        return `
        <div class="dashboard-card personal-info-container">
            <div class="personal-info-header-bg"></div>
            <div class="personal-info-content">
                <div class="personal-info-left">
                    <div class="avatar-large">${info.name.charAt(0)}</div>
                    <div class="user-name-large">${info.name}</div>
                    <div class="user-dept-badge">${info.department_name}</div>
                </div>
                <div class="personal-info-right">
                    <div class="info-grid">
                        <div class="info-grid-item">
                            <span class="info-grid-label">工号</span>
                            <span class="info-grid-value">${info.employee_id}</span>
                        </div>
                        <div class="info-grid-item">
                            <span class="info-grid-label">用户名</span>
                            <span class="info-grid-value">${info.username}</span>
                        </div>
                        <div class="info-grid-item">
                            <span class="info-grid-label">账号</span>
                            <span class="info-grid-value">${info.account}</span>
                        </div>
                        <div class="info-grid-item">
                            <span class="info-grid-label">邮箱</span>
                            <span class="info-grid-value">${info.email}</span>
                        </div>
                        <div class="info-grid-item">
                            <span class="info-grid-label">电话</span>
                            <span class="info-grid-value">${info.phone || '未填写'}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>`;
    }

    function renderTaskStats(stats) {
        return `
        <div class="dashboard-card">
            <h2 class="dashboard-card-title">任务统计</h2>
            <div class="task-stats-grid">
                <div class="task-stat-total">
                    <div class="stat-value">${stats.total}</div>
                    <div class="stat-label">任务总数</div>
                </div>
                <div class="task-stat-item">
                    <div class="stat-value">${stats.draft}</div>
                    <div class="stat-label">未发布</div>
                </div>
                <div class="task-stat-item">
                    <div class="stat-value">${stats.active}</div>
                    <div class="stat-label">进行中</div>
                </div>
                <div class="task-stat-item">
                    <div class="stat-value">${stats.closed}</div>
                    <div class="stat-label">已关闭</div>
                </div>
                <div class="task-stat-item">
                    <div class="stat-value">${stats.aggregated}</div>
                    <div class="stat-label">已汇总</div>
                </div>
                <div class="task-stat-item">
                    <div class="stat-value">${stats.needs_reaggregation}</div>
                    <div class="stat-label">需重新汇总</div>
                </div>
            </div>
        </div>`;
    }

    function renderEmailStats(stats) {
        return '<div class="dashboard-card"><h2 class="dashboard-card-title">邮件统计</h2><div class="stats-grid"><div class="stat-item"><div class="stat-value">' + stats.sent_total + '</div><div class="stat-label">已发出邮件</div></div><div class="stat-item"><div class="stat-value">' + stats.received_total + '</div><div class="stat-label">已收到邮件</div></div></div></div>';
    }

    function renderAggregationStats(stats) {
        return '<div class="dashboard-card"><h2 class="dashboard-card-title">汇总表单统计</h2><div class="stats-grid"><div class="stat-item"><div class="stat-value">' + stats.aggregated + '</div><div class="stat-label">已汇总邮件</div></div><div class="stat-item"><div class="stat-value">' + stats.not_aggregated + '</div><div class="stat-label">未汇总邮件</div></div><div class="stat-item"><div class="stat-value">' + stats.aggregation_count + '</div><div class="stat-label">已生成汇总表</div></div></div></div>';
    }

    async function loadDashboard() {
        console.log('[Dashboard] 数据加载开始');
        const container = document.getElementById('dashboardContainer');
        try {
            const result = await getDashboardData();
            if (result.success) {
                container.innerHTML = 
                    renderPersonalInfo(result.data.personal_info) + 
                    renderTaskStats(result.data.task_stats) + 
                    renderEmailStats(result.data.email_stats) + 
                    renderAggregationStats(result.data.email_stats);
            } else {
                container.innerHTML = '<div class="dashboard-error">' + result.message + '</div>';
            }
        } catch (error) {
            container.innerHTML = '<div class="dashboard-error">系统错误</div>';
        }
        console.log('[Dashboard] 数据加载完成');
    }

    (async function() {
        if (typeof CommonAPI === 'undefined') {
            await new Promise(resolve => setTimeout(resolve, 300));
        }
        await loadDashboard();
        console.log('[Dashboard] 页面初始化完成');
    })();
})();
</script>
