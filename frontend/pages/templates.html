<!-- è¡¨å•æ¨¡æ¿é¡µé¢ -->
<link rel="stylesheet" href="/frontend/static/css/templates-new.css?v=515537a3">

<div class="templates-container">
    <!-- é¡¶éƒ¨å·¥å…·æ  -->
    <h1 class="page-title">è¡¨å•æ¨¡æ¿</h1>
    <div class="toolbar">
        <div class="toolbar-left">
            <!-- ç­›é€‰æ§ä»¶ -->
            <div class="filter-group" style="display: inline-flex; gap: 8px;">
                <span style="font-size: 14px; color: #374151; margin-left: 8px;">åˆ›å»ºæ—¶é—´èŒƒå›´</span>
                <input type="date" id="templateStartDateFilter" class="filter-input" placeholder="èµ·å§‹æ—¶é—´">
                <span style="color: #9CA3AF;">â€”</span>
                <input type="date" id="templateEndDateFilter" class="filter-input" placeholder="ç»ˆæ­¢æ—¶é—´">
                <input type="text" id="templateNameFilter" class="filter-input" placeholder="è¾“å…¥æ¨¡æ¿åç§°">
                <button id="templateFilterBtn" class="btn-secondary">ç­›é€‰</button>
                <button id="templateResetFilterBtn" class="btn-secondary">é‡ç½®</button>
            </div>
        </div>
        <div class="toolbar-right">
            <button id="refreshTemplateBtn" class="btn-secondary" onclick="TemplatesPage.loadTemplates()" style="margin-right: 8px;">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>
                    <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
                </svg>
                åˆ·æ–°
            </button>
            <button class="btn-primary" onclick="TemplatesPage.openCreateModal()">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
                </svg>
                æ–°å»ºæ¨¡æ¿
            </button>
        </div>
    </div>

    <!-- æ¨¡æ¿åˆ—è¡¨è¡¨æ ¼ -->
    <div class="table-card">
        <table class="templates-table">
            <thead>
                <tr>
                    <th class="col-name sortable" data-sort="name">
                        æ¨¡æ¿åç§°
                        <span class="sort-icon">â‡…</span>
                    </th>
                    <th class="col-count sortable" data-sort="field_count">
                        å­—æ®µæ•°é‡
                        <span class="sort-icon">â‡…</span>
                    </th>
                    <th class="col-time sortable active" data-sort="created_at">
                        åˆ›å»ºæ—¶é—´
                        <span class="sort-icon">â–¼</span>
                    </th>
                    <th class="col-actions">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="templatesTableBody">
                <!-- è¡¨æ ¼å†…å®¹å°†é€šè¿‡ JS åŠ¨æ€åŠ è½½ -->
            </tbody>
        </table>
    </div>

<!-- åˆ›å»º/ç¼–è¾‘æ¨¡æ¿æ¨¡æ€æ¡† -->
<div id="templateFormModal" class="modal-overlay" style="display: none;">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title" id="templateFormModalTitle">æ–°å»ºæ¨¡æ¿</h3>
            <button class="close-btn" onclick="TemplatesPage.closeTemplateFormModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <form id="templateForm">
                <!-- Excelå¯¼å…¥ -->
                <div class="form-group" id="excelUploadSection">
                    <label class="form-label">ä» Excel å¯¼å…¥æ¨¡æ¿</label>
                    <input type="file" id="excelFileInput" accept=".xlsx,.xls" 
                           style="display: none;" onchange="TemplatesPage.handleExcelUpload(event)">
                    <div class="excel-upload-area" onclick="document.getElementById('excelFileInput').click()">
                        <div class="upload-icon">ğŸ“¤</div>
                        <div class="upload-text">ç‚¹å‡»ä¸Šä¼  Excel æ–‡ä»¶</div>
                        <div class="upload-hint" id="excelFileName">æ”¯æŒ .xlsx å’Œ .xls æ ¼å¼</div>
                    </div>
                </div>

                <!-- åŸºæœ¬ä¿¡æ¯ -->
                <div class="form-group">
                    <label class="form-label">
                        æ¨¡æ¿åç§° <span class="required">*</span>
                    </label>
                    <input type="text" class="form-input" id="templateName" 
                           placeholder="è¯·è¾“å…¥æ¨¡æ¿åç§°" required maxlength="100">
                </div>

                <div class="form-group">
                    <label class="form-label">æ¨¡æ¿æè¿°</label>
                    <textarea class="form-input form-textarea" id="templateDescription" 
                              placeholder="è¯·è¾“å…¥æ¨¡æ¿æè¿°ï¼ˆå¯é€‰ï¼‰"></textarea>
                </div>

                <!-- å­—æ®µç®¡ç† -->
                <div class="fields-section">
                    <div class="fields-header">
                        <span class="fields-title">è¡¨å•å­—æ®µ</span>
                        <button type="button" class="add-field-btn" onclick="TemplatesPage.addField()">
                            <i>â•</i> æ·»åŠ å­—æ®µ
                        </button>
                    </div>
                    <div id="fieldsList" class="fields-list">
                        <!-- å­—æ®µåˆ—è¡¨å°†é€šè¿‡ JS åŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </form>
        </div>
        <!-- Nested æ ¡éªŒè§„åˆ™ å¼¹çª—ï¼ˆæ”¾åœ¨åˆ›å»ºæ¨¡æ¿å¼¹çª—å†…éƒ¨ä»¥ä¾¿å±‚çº§ä¸€è‡´ï¼‰ -->
        <div id="validationRuleModal" class="modal-overlay" style="display: none;">
            <div class="modal" style="max-width: 560px;">
                <div class="modal-header">
                    <h3 class="modal-title" id="validationRuleModalTitle">è®¾ç½®æ ¡éªŒè§„åˆ™</h3>
                    <button class="close-btn" onclick="TemplatesPage.closeValidationModal()">Ã—</button>
                </div>
                <div class="modal-body" style="padding: 24px;">
                    <!-- å­—æ®µç±»å‹ -->
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label class="form-label" style="font-size: 14px; font-weight: 600; color: #1F2937; margin-bottom: 8px;">å­—æ®µç±»å‹</label>
                        <select id="validationTypeSelect" class="form-select" style="width: 100%;">
                            <option value="">ï¼ˆä¸é™åˆ¶ï¼‰</option>
                            <option value="TEXT">æ–‡æœ¬</option>
                            <option value="INTEGER">æ•´æ•°</option>
                            <option value="FLOAT">å°æ•°</option>
                            <option value="DATE">æ—¥æœŸ</option>
                            <option value="DATETIME">æ—¥æœŸæ—¶é—´</option>
                            <option value="BOOLEAN">æ˜¯/å¦</option>
                            <option value="EMAIL">é‚®ç®±</option>
                            <option value="PHONE">ç”µè¯å·ç </option>
                            <option value="ID_CARD">èº«ä»½è¯å·</option>
                            <option value="EMPLOYEE_ID">å·¥å·</option>
                        </select>
                    </div>
                    
                    <!-- æ˜¯å¦å¿…å¡« -->
                    <div class="form-group" style="margin-bottom: 20px;">
                        <div class="toggle-wrapper">
                            <span class="toggle-label" style="font-size: 14px; font-weight: 600; color: #1F2937;">æ˜¯å¦å¿…å¡«</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="validationRequired">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- åˆ†éš”çº¿ -->
                    <div style="border-top: 1px solid #E5E7EB; margin: 20px 0;"></div>
                    
                    <!-- æ¡ä»¶è®¾ç½®åŒºåŸŸ -->
                    <div id="validationHints">
                        <!-- æ•°å­—ç±»å‹é™åˆ¶ -->
                        <div class="numeric-group" style="display:none;">
                            <h4 style="font-size: 13px; font-weight: 600; color: #6B7280; margin-bottom: 12px;">æ•°å€¼èŒƒå›´é™åˆ¶</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                <div class="form-group" style="margin: 0;">
                                    <label class="form-label" style="font-size: 13px; color: #6B7280;">æœ€å°å€¼</label>
                                    <input type="number" id="validationMin" class="form-input" placeholder="å¯é€‰" />
                                </div>
                                <div class="form-group" style="margin: 0;">
                                    <label class="form-label" style="font-size: 13px; color: #6B7280;">æœ€å¤§å€¼</label>
                                    <input type="number" id="validationMax" class="form-input" placeholder="å¯é€‰" />
                                </div>
                            </div>
                        </div>
                        
                        <!-- æ–‡æœ¬ç±»å‹é™åˆ¶ -->
                        <div class="text-group" style="display:none;">
                            <h4 style="font-size: 13px; font-weight: 600; color: #6B7280; margin-bottom: 12px;">æ–‡æœ¬é•¿åº¦é™åˆ¶</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                <div class="form-group" style="margin: 0;">
                                    <label class="form-label" style="font-size: 13px; color: #6B7280;">æœ€å°é•¿åº¦</label>
                                    <input type="number" id="validationMinLen" class="form-input" placeholder="å¯é€‰" />
                                </div>
                                <div class="form-group" style="margin: 0;">
                                    <label class="form-label" style="font-size: 13px; color: #6B7280;">æœ€å¤§é•¿åº¦</label>
                                    <input type="number" id="validationMaxLen" class="form-input" placeholder="å¯é€‰" />
                                </div>
                            </div>
                        </div>
                        
                        <!-- æ—¥æœŸç±»å‹æç¤º -->
                        <div class="date-hint" style="display:none; background: #F3F4F6; padding: 12px; border-radius: 8px; margin-top: 8px;">
                            <div style="display: flex; align-items: start; gap: 8px;">
                                <svg width="16" height="16" style="flex-shrink: 0; margin-top: 2px;" fill="#6B7280" viewBox="0 0 16 16">
                                    <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                                    <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/>
                                </svg>
                                <div style="font-size: 13px; color: #6B7280; line-height: 1.5;">
                                    <div id="dateHint">æ—¥æœŸç±»å‹åªé™åˆ¶å¹´æœˆæ—¥ï¼Œä¸åŒ…å«å…·ä½“æ—¶é—´ç‚¹ã€‚</div>
                                    <div id="datetimeHint" style="display:none;">æ—¥æœŸæ—¶é—´ç±»å‹åŒ…å«å…·ä½“çš„æ—¶é—´ç‚¹ï¼ˆæ—¶:åˆ†ï¼‰ã€‚</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="TemplatesPage.closeValidationModal()">å–æ¶ˆ</button>
                    <button class="btn btn-primary" onclick="TemplatesPage.saveValidationRule()">ä¿å­˜</button>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="TemplatesPage.closeTemplateFormModal()">å–æ¶ˆ</button>
            <button class="btn btn-primary" onclick="TemplatesPage.saveTemplate()">ä¿å­˜</button>
        </div>
    </div>
</div>

<!-- æ¨¡æ¿æè¿°å¼¹çª— -->
<div id="templateDescModal" class="modal-overlay" style="display: none;">
    <div class="modal modal-detail">
        <div class="modal-header">
            <h3 class="modal-title" id="templateDescModalTitle">æ¨¡æ¿æè¿°</h3>
            <button class="close-btn" onclick="TemplatesPage.closeTemplateDescModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <p id="templateDescContent" style="line-height: 1.8; color: #4B5563;"></p>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="TemplatesPage.closeTemplateDescModal()">å…³é—­</button>
        </div>
    </div>
</div>

<!-- å­—æ®µè¯¦æƒ…å¼¹çª— -->
<div id="fieldDetailModal" class="modal-overlay" style="display: none;">
    <div class="modal modal-detail" style="max-width: 700px;">
        <div class="modal-header">
            <h3 class="modal-title" id="fieldDetailModalTitle">å­—æ®µè¯¦æƒ…</h3>
            <button class="close-btn" onclick="TemplatesPage.closeFieldDetailModal()">Ã—</button>
        </div>
        <div class="modal-body" style="padding: 24px;">
            <div id="fieldDetailContent" class="field-detail-list"></div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="TemplatesPage.closeFieldDetailModal()">å…³é—­</button>
        </div>
    </div>
</div>

<script src="/frontend/static/js/api/templates.js?v=c0d4d034"></script>
<script>
// ä½¿ç”¨ IIFE é¿å…å…¨å±€å˜é‡æ±¡æŸ“ï¼Œæ¯æ¬¡åŠ è½½é¡µé¢æ—¶åˆ›å»ºæ–°å®ä¾‹
(function() {
const TemplatesPage = (() => {
    // ç§æœ‰å˜é‡
    let templates = [];
    let filteredTemplates = [];
    let currentTemplate = null;
    let editingTemplateId = null;
    let draggedElement = null;
    let fieldCounter = 0;
    let sortBy = 'created_at';
    let sortOrder = 'desc';
    let filters = {
        startDate: '',
        endDate: '',
        keyword: ''
    };

    // å­—æ®µç±»å‹é€‰é¡¹
    const fieldTypes = [
        { value: 'TEXT', label: 'æ–‡æœ¬' },
        { value: 'INTEGER', label: 'æ•´æ•°' },
        { value: 'FLOAT', label: 'å°æ•°' },
        { value: 'DATE', label: 'æ—¥æœŸ' },
        { value: 'DATETIME', label: 'æ—¥æœŸæ—¶é—´' },
        { value: 'BOOLEAN', label: 'æ˜¯/å¦' },
        { value: 'EMAIL', label: 'é‚®ç®±' },
        { value: 'PHONE', label: 'ç”µè¯å·ç ' },
        { value: 'ID_CARD', label: 'èº«ä»½è¯å·' },
        { value: 'EMPLOYEE_ID', label: 'å·¥å·' }
    ];

    // ==================== åˆå§‹åŒ– ====================
    async function init() {
        console.log('[Templates] é¡µé¢åˆå§‹åŒ–å¼€å§‹');
        await loadTemplates();
        bindSortEvents();
        bindFilterEvents();
        console.log('[Templates] é¡µé¢åˆå§‹åŒ–å®Œæˆ');
    }

    function bindSortEvents() {
        // ç›´æ¥ç»‘å®šï¼Œå› ä¸ºDOMç°åœ¨æ˜¯é™æ€çš„
        document.querySelectorAll('.sortable').forEach(th => {
            th.addEventListener('click', () => {
                const sortByField = th.dataset.sort;
                handleSort(sortByField);
            });
        });
    }

    function bindFilterEvents() {
        const filterBtn = document.getElementById('templateFilterBtn');
        const resetBtn = document.getElementById('templateResetFilterBtn');
        const startDateInput = document.getElementById('templateStartDateFilter');
        const endDateInput = document.getElementById('templateEndDateFilter');
        const nameInput = document.getElementById('templateNameFilter');
        
        if (filterBtn) {
            filterBtn.addEventListener('click', applyFilters);
        }
        
        if (resetBtn) {
            resetBtn.addEventListener('click', resetFilters);
        }

        if (nameInput) {
            nameInput.addEventListener('keydown', (event) => {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    applyFilters();
                }
            });
        }
    }

    // ==================== ç­›é€‰åŠŸèƒ½ ====================
    
    function applyFilters() {
        filters.startDate = document.getElementById('templateStartDateFilter').value;
        filters.endDate = document.getElementById('templateEndDateFilter').value;
        filters.keyword = document.getElementById('templateNameFilter').value.trim().toLowerCase();
        
        filteredTemplates = templates.filter(template => {
            // èµ·å§‹æ—¶é—´ç­›é€‰
            if (filters.startDate && template.created_at) {
                const templateDate = new Date(template.created_at).toISOString().split('T')[0];
                if (templateDate < filters.startDate) {
                    return false;
                }
            }
            
            // ç»ˆæ­¢æ—¶é—´ç­›é€‰
            if (filters.endDate && template.created_at) {
                const templateDate = new Date(template.created_at).toISOString().split('T')[0];
                if (templateDate > filters.endDate) {
                    return false;
                }
            }
            
            if (filters.keyword) {
                const templateName = (template.name || '').toLowerCase();
                if (!templateName.includes(filters.keyword)) {
                    return false;
                }
            }
            
            return true;
        });
        
        sortAndRenderTemplates();
    }
    
    function resetFilters() {
        document.getElementById('templateStartDateFilter').value = '';
        document.getElementById('templateEndDateFilter').value = '';
        document.getElementById('templateNameFilter').value = '';
        filters = {
            startDate: '',
            endDate: '',
            keyword: ''
        };
        filteredTemplates = [];
        sortAndRenderTemplates();
    }

    // ==================== æ¨¡æ¿åˆ—è¡¨ ====================
    
    async function loadTemplates() {
        console.log('[Templates] æ¨¡æ¿åˆ—è¡¨åŠ è½½å¼€å§‹');
        const tbody = document.getElementById('templatesTableBody');
        tbody.innerHTML = `
            <tr>
                <td colspan="4" style="padding: 0; border: none;">
                    <div class="loading-state" style="text-align: center; padding: 40px;">
                        <div class="loading-spinner" style="margin: 0 auto 10px;"></div>
                        <div>åŠ è½½ä¸­...</div>
                    </div>
                </td>
            </tr>
        `;

        try {
            templates = await TemplateAPI.getTemplates();
            sortAndRenderTemplates();
            console.log('[Templates] æ¨¡æ¿åˆ—è¡¨åŠ è½½å®Œæˆ');
        } catch (error) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="4" style="padding: 0; border: none;">
                        <div class="empty-state">
                            <i>âš ï¸</i>
                            <p>åŠ è½½å¤±è´¥: ${error.message}</p>
                            <button class="btn btn-primary" onclick="TemplatesPage.loadTemplates()">é‡è¯•</button>
                        </div>
                    </td>
                </tr>
            `;
        }
    }

    function sortAndRenderTemplates() {
        const templatesToSort = filteredTemplates.length > 0 || filters.startDate || filters.endDate || filters.keyword
            ? filteredTemplates
            : templates;
        
        const sorted = [...templatesToSort].sort((a, b) => {
            let aVal = a[sortBy];
            let bVal = b[sortBy];

            // å¤„ç†null/undefinedå€¼
            if (aVal == null) aVal = '';
            if (bVal == null) bVal = '';

            // å­—ç¬¦ä¸²æ¯”è¾ƒ
            if (typeof aVal === 'string') {
                const result = aVal.localeCompare(bVal);
                return sortOrder === 'asc' ? result : -result;
            }

            // æ•°å­—/æ—¥æœŸæ¯”è¾ƒ
            if (sortOrder === 'asc') {
                return aVal > bVal ? 1 : -1;
            } else {
                return aVal < bVal ? 1 : -1;
            }
        });

        renderTemplateList(sorted);
        updateSortUI();
    }

    function handleSort(sortByField) {
        if (sortBy === sortByField) {
            sortOrder = sortOrder === 'asc' ? 'desc' : 'asc';
        } else {
            sortBy = sortByField;
            sortOrder = 'desc';
        }
        sortAndRenderTemplates();
    }

    function updateSortUI() {
        document.querySelectorAll('.sortable').forEach(th => {
            th.classList.remove('active');
            const icon = th.querySelector('.sort-icon');
            if (icon) icon.textContent = 'â‡…';
        });

        const activeTh = document.querySelector(`[data-sort="${sortBy}"]`);
        if (activeTh) {
            activeTh.classList.add('active');
            const icon = activeTh.querySelector('.sort-icon');
            if (icon) icon.textContent = sortOrder === 'asc' ? 'â–²' : 'â–¼';
        }
    }

    function renderTemplateList(sortedTemplates = templates) {
        const tbody = document.getElementById('templatesTableBody');

        let tbodyContent = '';
        
        if (sortedTemplates.length === 0) {
            tbodyContent = `
                <tr>
                    <td colspan="4" style="padding: 0; border: none;">
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ“‹</div>
                            <div class="empty-state-text">æš‚æ— æ¨¡æ¿ï¼Œç‚¹å‡»å³ä¸Šè§’åˆ›å»ºæ–°æ¨¡æ¿</div>
                        </div>
                    </td>
                </tr>
            `;
        } else {
            tbodyContent = sortedTemplates.map(template => `
                <tr>
                    <td class="col-name">
                        <a href="#" class="template-name-link" onclick="TemplatesPage.viewTemplateDesc(${template.id}, '${escapeHtml(template.name)}', '${escapeHtml(template.description || '')}'); return false;">
                            ${escapeHtml(template.name)}
                        </a>
                    </td>
                    <td class="col-count">
                        <a href="#" class="field-count-link" onclick="TemplatesPage.viewTemplateFields(${template.id}); return false;">${template.field_count}</a>
                    </td>
                    <td class="col-time">${formatDateTime(template.created_at)}</td>
                    <td class="col-actions">
                        <div class="action-buttons">
                            <button class="btn-secondary btn-sm" onclick="TemplatesPage.openEditModal(${template.id})">
                                ç¼–è¾‘
                            </button>
                            <button class="btn-danger btn-sm" onclick="TemplatesPage.deleteTemplate(${template.id})">
                                åˆ é™¤
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        tbody.innerHTML = tbodyContent;
        
        // ä¸éœ€è¦é‡æ–°ç»‘å®šæ’åºäº‹ä»¶ï¼Œå› ä¸ºtheadæ˜¯é™æ€çš„
    }

    // ==================== æŸ¥çœ‹æ¨¡æ¿æè¿° ====================
    
    function viewTemplateDesc(templateId, templateName, description) {
        document.getElementById('templateDescModalTitle').textContent = templateName;
        const content = document.getElementById('templateDescContent');
        
        if (description && description !== 'null' && description.trim()) {
            content.textContent = description;
        } else {
            content.innerHTML = '<p style="color: #bbb;">æš‚æ— æè¿°</p>';
        }
        
        document.getElementById('templateDescModal').style.display = 'flex';
    }
    
    function closeTemplateDescModal() {
        document.getElementById('templateDescModal').style.display = 'none';
    }

    // ==================== æŸ¥çœ‹å­—æ®µè¯¦æƒ… ====================
    
    async function viewTemplateFields(templateId) {
        try {
            const template = await TemplateAPI.getTemplateDetail(templateId);
            currentTemplate = template;

            document.getElementById('fieldDetailModalTitle').textContent = `${template.name} - å­—æ®µè¯¦æƒ…`;

            const content = document.getElementById('fieldDetailContent');

            if (template.fields.length === 0) {
                content.innerHTML = `
                    <div class="empty-state" style="padding: 40px; text-align: center;">
                        <div style="font-size: 48px; margin-bottom: 12px;">ğŸ“‹</div>
                        <p style="color: #9CA3AF;">è¯¥æ¨¡æ¿æš‚æ— å­—æ®µ</p>
                    </div>
                `;
            } else {
                content.innerHTML = template.fields.map((field, index) => {
                    const rule = field.validation_rule || {};
                    const typeLabel = rule.type ? getFieldTypeLabel(rule.type) : 'ä¸é™åˆ¶';
                    
                    // Build constraints info
                    let constraints = [];
                    if (rule.min !== undefined && rule.min !== null) constraints.push(`æœ€å°å€¼: ${rule.min}`);
                    if (rule.max !== undefined && rule.max !== null) constraints.push(`æœ€å¤§å€¼: ${rule.max}`);
                    if (rule.min_length !== undefined && rule.min_length !== null) constraints.push(`æœ€å°é•¿åº¦: ${rule.min_length}`);
                    if (rule.max_length !== undefined && rule.max_length !== null) constraints.push(`æœ€å¤§é•¿åº¦: ${rule.max_length}`);
                    
                    return `
                        <div class="field-detail-card">
                            <div class="field-detail-header">
                                <div class="field-index">#${index + 1}</div>
                                <div class="field-name-section">
                                    <span class="field-name">${escapeHtml(field.display_name)}</span>
                                    <div class="field-badges">
                                        <span class="field-type-badge-modal">${typeLabel || 'ä¸é™åˆ¶'}</span>
                                        ${rule.required ? '<span class="field-required-badge-modal">å¿…å¡«</span>' : '<span class="field-optional-badge-modal">å¯é€‰</span>'}
                                    </div>
                                </div>
                            </div>
                            ${constraints.length > 0 ? `
                                <div class="field-constraints">
                                    <div class="constraints-title">ğŸ“ æ ¡éªŒè§„åˆ™</div>
                                    <div class="constraints-list">
                                        ${constraints.map(c => `<span class="constraint-item">${c}</span>`).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('');
            }

            document.getElementById('fieldDetailModal').style.display = 'flex';
        } catch (error) {
            alert('åŠ è½½æ¨¡æ¿è¯¦æƒ…å¤±è´¥: ' + error.message);
        }
    }

    function closeFieldDetailModal() {
        document.getElementById('fieldDetailModal').style.display = 'none';
        currentTemplate = null;
    }

    // ==================== Excel ä¸Šä¼ å¤„ç† ====================
    
    async function handleExcelUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const fileNameSpan = document.getElementById('excelFileName');
        fileNameSpan.textContent = 'æ­£åœ¨è§£æ...';
        fileNameSpan.className = 'upload-hint loading';
        
        try {
            const result = await TemplateAPI.parseExcel(file);
            
            // å¡«å……æ¨¡æ¿åç§°
            if (result.template_name) {
                document.getElementById('templateName').value = result.template_name;
            }
            
            // æ¸…ç©ºç°æœ‰å­—æ®µ
            document.getElementById('fieldsList').innerHTML = '';
            fieldCounter = 0;
            
            // æ·»åŠ è§£æå‡ºçš„å­—æ®µ
            if (result.fields && result.fields.length > 0) {
                result.fields.forEach(field => {
                    addField({
                        display_name: field.display_name,
                        validation_rule: field.validation_rule,
                        ord: field.ord
                    });
                });
            }
            
            fileNameSpan.textContent = `âœ“ å·²å¯¼å…¥ ${result.fields.length} ä¸ªå­—æ®µ`;
            fileNameSpan.className = 'upload-hint success';
            
            // 3ç§’åæ¢å¤æç¤ºæ–‡æœ¬
            setTimeout(() => {
                fileNameSpan.textContent = 'æ”¯æŒ .xlsx å’Œ .xls æ ¼å¼';
                fileNameSpan.className = 'upload-hint';
            }, 3000);
        } catch (error) {
            fileNameSpan.textContent = 'âœ— è§£æå¤±è´¥: ' + error.message;
            fileNameSpan.className = 'upload-hint error';
            
            setTimeout(() => {
                fileNameSpan.textContent = 'æ”¯æŒ .xlsx å’Œ .xls æ ¼å¼';
                fileNameSpan.className = 'upload-hint';
            }, 3000);
        }
        
        // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©
        event.target.value = '';
    }

    // ==================== åˆ›å»ºæ¨¡æ¿ ====================
    
    function openCreateModal() {
        editingTemplateId = null;
        fieldCounter = 0;

        document.getElementById('templateFormModalTitle').textContent = 'æ–°å»ºæ¨¡æ¿';
        document.getElementById('templateName').value = '';
        document.getElementById('templateDescription').value = '';
        document.getElementById('fieldsList').innerHTML = '';
        document.getElementById('excelUploadSection').style.display = 'block';

        // é»˜è®¤æ·»åŠ ä¸€ä¸ªå­—æ®µ
        addField();

        document.getElementById('templateFormModal').style.display = 'flex';
    }

    // ==================== ç¼–è¾‘æ¨¡æ¿ ====================
    
    async function openEditModal(templateId) {
        try {
            const template = await TemplateAPI.getTemplateDetail(templateId);
            editingTemplateId = templateId;
            currentTemplate = template;
            fieldCounter = 0;

            document.getElementById('templateFormModalTitle').textContent = 'ç¼–è¾‘æ¨¡æ¿';
            document.getElementById('templateName').value = template.name;
            document.getElementById('templateDescription').value = template.description || '';
            document.getElementById('excelUploadSection').style.display = 'none';

            // æ¸²æŸ“ç°æœ‰å­—æ®µ
            const fieldsList = document.getElementById('fieldsList');
            fieldsList.innerHTML = '';

            template.fields.forEach(field => {
                addField(field);
            });

            document.getElementById('templateFormModal').style.display = 'flex';
        } catch (error) {
            alert('åŠ è½½æ¨¡æ¿è¯¦æƒ…å¤±è´¥: ' + error.message);
        }
    }

    function closeTemplateFormModal() {
        document.getElementById('templateFormModal').style.display = 'none';
        editingTemplateId = null;
        currentTemplate = null;
        // Ensure nested validation modal is closed if open
        try { TemplatesPage.closeValidationModal(); } catch(e) {}
    }

    // ==================== Validation Modal ====================
    let currentValidationEditingFieldId = null;
    function openValidationModal(fieldId) {
        currentValidationEditingFieldId = fieldId;
        const hidden = document.getElementById(`field_validation_${fieldId}`);
        const raw = hidden ? (hidden.value || '') : '';
        let rule = null;
        if (raw) {
            try { rule = JSON.parse(raw); } catch (e) { rule = null; }
        }
        // Populate fields
        document.getElementById('validationTypeSelect').value = rule && rule.type ? rule.type : '';
        document.getElementById('validationRequired').checked = rule && rule.required;
        document.getElementById('validationMin').value = rule && rule.min != null ? rule.min : '';
        document.getElementById('validationMax').value = rule && rule.max != null ? rule.max : '';
        document.getElementById('validationMinLen').value = rule && rule.min_length != null ? rule.min_length : '';
        document.getElementById('validationMaxLen').value = rule && rule.max_length != null ? rule.max_length : '';
        // Initialize hint visibility for date/datetime
        try { document.getElementById('dateHint').style.display = 'none'; } catch(e) {}
        try { document.getElementById('datetimeHint').style.display = 'none'; } catch(e) {}
        document.getElementById('validationRuleModal').style.display = 'flex';
        // ensure type-specific fields visibility are updated
        // Avoid duplicate listeners: remove if present then add
        try { document.getElementById('validationTypeSelect').removeEventListener('change', onValidationTypeChange); } catch(e) {}
        document.getElementById('validationTypeSelect').addEventListener('change', onValidationTypeChange);
        onValidationTypeChange();
        // Reflect existing values onto the field row badges
        const fieldItemRow = document.querySelector(`[data-field-id="${fieldId}"]`);
        if (fieldItemRow) {
            const typeBadge = fieldItemRow.querySelector('.field-type-badge');
            const requiredBadge = fieldItemRow.querySelector('.required-badge');
            // Type badge: always show, default to "ï¼ˆä¸é™åˆ¶ï¼‰" if no type
            if (typeBadge) {
                const typeLabel = rule && rule.type ? getFieldTypeLabel(rule.type) : '';
                typeBadge.textContent = typeLabel || 'ï¼ˆä¸é™åˆ¶ï¼‰';
            }
            // Required badge: only show if required=true, otherwise hide completely
            if (requiredBadge) {
                if (rule && rule.required) {
                    requiredBadge.style.display = 'inline-block';
                    requiredBadge.textContent = 'å¿…å¡«';
                } else {
                    requiredBadge.style.display = 'none';
                    requiredBadge.textContent = '';
                }
            }
        }
    }

    function closeValidationModal() {
        currentValidationEditingFieldId = null;
        document.getElementById('validationRuleModal').style.display = 'none';
    }

    function saveValidationRule() {
        const ttype = document.getElementById('validationTypeSelect').value;
        const trequired = document.getElementById('validationRequired').checked;
        // Collect only visible values by type
        const tmin = (ttype === 'INTEGER' || ttype === 'FLOAT') ? document.getElementById('validationMin').value : '';
        const tmax = (ttype === 'INTEGER' || ttype === 'FLOAT') ? document.getElementById('validationMax').value : '';
        const tminlen = (ttype === 'TEXT') ? document.getElementById('validationMinLen').value : '';
        const tmaxlen = (ttype === 'TEXT') ? document.getElementById('validationMaxLen').value : '';
        let content = '';
        if (currentValidationEditingFieldId === null || currentValidationEditingFieldId === undefined) {
            alert('æœªé€‰æ‹©å­—æ®µ');
            return;
        }
        // validate as JSON
        let rule = null;
        if (ttype || trequired || tmin || tmax || tminlen || tmaxlen) {
            rule = { required: !!trequired };
            if (ttype) rule.type = ttype;
            if (tmin !== '') rule.min = parseFloat(tmin);
            if (tmax !== '') rule.max = parseFloat(tmax);
            if (tminlen !== '') rule.min_length = parseInt(tminlen);
            if (tmaxlen !== '') rule.max_length = parseInt(tmaxlen);
            // No regex/options allowed in this frontend modal; advanced rules may be backend-only
        }
        const hidden = document.getElementById(`field_validation_${currentValidationEditingFieldId}`);
        if (hidden) {
            hidden.value = rule ? JSON.stringify(rule) : '';
        }
        // Update badges in the field-line (always update, regardless of summary element)
        const fieldItem = document.querySelector(`[data-field-id="${currentValidationEditingFieldId}"]`);
        if (fieldItem) {
            const typeBadge = fieldItem.querySelector('.field-type-badge');
            const requiredBadge = fieldItem.querySelector('.required-badge');
            // Type badge: always show, default to "ï¼ˆä¸é™åˆ¶ï¼‰" if no type
            if (typeBadge) {
                const typeLabel = rule && rule.type ? getFieldTypeLabel(rule.type) : '';
                typeBadge.textContent = typeLabel || 'ï¼ˆä¸é™åˆ¶ï¼‰';
            }
            // Required badge: only show if required=true, otherwise hide completely
            if (requiredBadge) {
                if (rule && rule.required) {
                    requiredBadge.style.display = 'inline-block';
                    requiredBadge.textContent = 'å¿…å¡«';
                } else {
                    requiredBadge.style.display = 'none';
                    requiredBadge.textContent = '';
                }
            }
        }
        closeValidationModal();
    }

    // ==================== å­—æ®µç®¡ç† ====================
    
    function addField(fieldData = null) {
        const fieldId = fieldCounter++;
        const fieldsList = document.getElementById('fieldsList');

        const fieldItem = document.createElement('div');
        fieldItem.className = 'field-item';
        fieldItem.draggable = true;
        fieldItem.dataset.fieldId = fieldId;

        fieldItem.innerHTML = `
            <div class="field-inline">
                <span class="drag-handle" title="æ‹–åŠ¨æ’åº">â˜°</span>
                <span class="field-number">#${fieldsList.children.length + 1}</span>
                <input type="text" class="form-input" name="field_name_${fieldId}" 
                       placeholder="å­—æ®µåç§°" required maxlength="100"
                       value="${fieldData ? escapeHtml(fieldData.display_name) : ''}">
                <span class="field-type-badge" style="background-color: #DBEAFE; color: #1E40AF; border: 1px solid #93C5FD; padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 600; display: inline-block; min-width: 60px; text-align: center;">
                    ${fieldData && fieldData.validation_rule && fieldData.validation_rule.type ? getFieldTypeLabel(fieldData.validation_rule.type) : 'ï¼ˆä¸é™åˆ¶ï¼‰'}
                </span>
                <span class="required-badge" style="background-color: #FEE2E2; color: #991B1B; border: 1px solid #FCA5A5; padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 600; margin-left: 8px; display: ${fieldData && fieldData.validation_rule && fieldData.validation_rule.required ? 'inline-block' : 'none'};">
                    ${fieldData && fieldData.validation_rule && fieldData.validation_rule.required ? 'å¿…å¡«' : ''}
                </span>
                <button type="button" class="btn-secondary" id="rule_btn_${fieldId}" onclick="TemplatesPage.openValidationModal(${fieldId})">è®¾ç½®æ ¡éªŒè§„åˆ™</button>
                <input type="hidden" id="field_validation_${fieldId}" name="field_validation_${fieldId}" value='${fieldData && fieldData.validation_rule ? JSON.stringify(fieldData.validation_rule) : ''}'>
                <button type="button" class="field-control-btn delete" onclick="TemplatesPage.removeField(${fieldId})" title="åˆ é™¤å­—æ®µ">
                    Ã—
                </button>
            </div>
        `;

        // æ·»åŠ æ‹–æ‹½äº‹ä»¶
        fieldItem.addEventListener('dragstart', handleDragStart);
        fieldItem.addEventListener('dragover', handleDragOver);
        fieldItem.addEventListener('drop', handleDrop);
        fieldItem.addEventListener('dragend', handleDragEnd);

        fieldsList.appendChild(fieldItem);
        updateFieldNumbers();
    }

    function removeField(fieldId) {
        const fieldItem = document.querySelector(`[data-field-id="${fieldId}"]`);
        if (fieldItem) {
            fieldItem.remove();
            updateFieldNumbers();
        }
    }

    function updateFieldNumbers() {
        const fieldItems = document.querySelectorAll('.field-item');
        fieldItems.forEach((item, index) => {
            const numberSpan = item.querySelector('.field-number');
            if (numberSpan) {
                numberSpan.textContent = index + 1;
            }
        });
    }

    // ==================== æ‹–æ‹½æ’åº ====================
    
    function handleDragStart(e) {
        draggedElement = this;
        this.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
    }

    function handleDragOver(e) {
        if (e.preventDefault) {
            e.preventDefault();
        }
        e.dataTransfer.dropEffect = 'move';

        const afterElement = getDragAfterElement(e.clientY);
        const fieldsList = document.getElementById('fieldsList');

        if (afterElement == null) {
            fieldsList.appendChild(draggedElement);
        } else {
            fieldsList.insertBefore(draggedElement, afterElement);
        }

        return false;
    }

    function handleDrop(e) {
        if (e.stopPropagation) {
            e.stopPropagation();
        }
        updateFieldNumbers();
        return false;
    }

    function handleDragEnd(e) {
        this.classList.remove('dragging');
        draggedElement = null;
    }

    function getDragAfterElement(y) {
        const fieldsList = document.getElementById('fieldsList');
        const draggableElements = [...fieldsList.querySelectorAll('.field-item:not(.dragging)')];

        return draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;

            if (offset < 0 && offset > closest.offset) {
                return { offset: offset, element: child };
            } else {
                return closest;
            }
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    // ==================== ä¿å­˜æ¨¡æ¿ ====================
    
    async function saveTemplate() {
        const name = document.getElementById('templateName').value.trim();
        const description = document.getElementById('templateDescription').value.trim();

        if (!name) {
            alert('è¯·è¾“å…¥æ¨¡æ¿åç§°');
            return;
        }

        // æ”¶é›†å­—æ®µæ•°æ®
        const fieldItems = document.querySelectorAll('.field-item');
        if (fieldItems.length === 0) {
            alert('è¯·è‡³å°‘æ·»åŠ ä¸€ä¸ªå­—æ®µ');
            return;
        }

        const fields = [];
        let hasError = false;

        fieldItems.forEach((item, index) => {
            const fieldId = item.dataset.fieldId;
            const fieldName = document.querySelector(`[name="field_name_${fieldId}"]`).value.trim();
            const validationHidden = document.getElementById(`field_validation_${fieldId}`);
            let fieldValidation = null;
            if (validationHidden && validationHidden.value) {
                try {
                    fieldValidation = JSON.parse(validationHidden.value);
                } catch (err) {
                    alert('å­—æ®µæ ¡éªŒè§„åˆ™ JSON è§£æå¤±è´¥: ' + err.message);
                    hasError = true;
                    return;
                }
            }

            if (!fieldName) {
                alert(`ç¬¬ ${index + 1} ä¸ªå­—æ®µçš„åç§°ä¸èƒ½ä¸ºç©º`);
                hasError = true;
                return;
            }

            fields.push({
                display_name: fieldName,
                validation_rule: fieldValidation,
                ord: index  // ç›´æ¥ä½¿ç”¨indexä½œä¸ºordï¼Œä»0å¼€å§‹
            });
        });

        if (hasError) {
            return;
        }

        const data = {
            name: name,
            description: description || null,
            fields: fields
        };

        try {
            if (editingTemplateId) {
                await TemplateAPI.updateTemplate(editingTemplateId, data);
                alert('æ¨¡æ¿æ›´æ–°æˆåŠŸ');
            } else {
                await TemplateAPI.createTemplate(data);
                alert('æ¨¡æ¿åˆ›å»ºæˆåŠŸ');
            }

            closeTemplateFormModal();
            await loadTemplates();
        } catch (error) {
            alert('ä¿å­˜å¤±è´¥: ' + error.message);
        }
    }

    // ==================== åˆ é™¤æ¨¡æ¿ ====================
    
    async function deleteTemplate(templateId) {
        if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ¨¡æ¿å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
            return;
        }

        try {
            await TemplateAPI.deleteTemplate(templateId);
            alert('æ¨¡æ¿åˆ é™¤æˆåŠŸ');
            await loadTemplates();
        } catch (error) {
            alert('åˆ é™¤å¤±è´¥: ' + error.message);
        }
    }

    // ==================== å·¥å…·å‡½æ•° ====================
    
    function formatDateTime(dateString) {
        const date = new Date(dateString);
        return date.toLocaleString('zh-CN', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function getFieldTypeLabel(type) {
        if (!type) return 'ï¼ˆä¸é™åˆ¶ï¼‰';
        const typeObj = fieldTypes.find(t => t.value === type);
        // For backend-only or unrecognized types (EMAIL/EMPLOYEE_ID etc.) do not display on the frontend
        return typeObj ? typeObj.label : '';
    }

    // Show/hide details in Validation modal based on selected type
    function onValidationTypeChange() {
        const type = document.getElementById('validationTypeSelect').value;
        const numericGroups = document.querySelectorAll('.numeric-group');
        const textGroups = document.querySelectorAll('.text-group');
        const dateHint = document.getElementById('dateHint');
        const datetimeHint = document.getElementById('datetimeHint');

        // Hide all groups first
        numericGroups.forEach(n => n.style.display = 'none');
        textGroups.forEach(t => t.style.display = 'none');

        if (type === 'INTEGER' || type === 'FLOAT') {
            numericGroups.forEach(n => n.style.display = 'block');
        }

        if (type === 'TEXT') {
            textGroups.forEach(t => t.style.display = 'block');
        }
        // date/datetime hints
        if (dateHint) dateHint.style.display = (type === 'DATE') ? 'block' : 'none';
        if (datetimeHint) datetimeHint.style.display = (type === 'DATETIME') ? 'block' : 'none';
        // For email/phone/id/employee/date/datetime/boolean: no extra fields shown except required
    }

    // ==================== å…¬å¼€æ¥å£ ====================
    
    return {
        init,
        loadTemplates,
        viewTemplateDesc,
        closeTemplateDescModal,
        viewTemplateFields,
        closeFieldDetailModal,
        openCreateModal,
        openEditModal,
        closeTemplateFormModal,
        handleExcelUpload,
        addField,
        removeField,
        saveTemplate,
        openValidationModal,
        closeValidationModal,
        saveValidationRule,
        deleteTemplate
    };
})();

// å°† TemplatesPage æš´éœ²åˆ°å…¨å±€ä¾› onclick ä½¿ç”¨
window.TemplatesPage = TemplatesPage;

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
TemplatesPage.init();
})();
</script>
