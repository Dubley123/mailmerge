<!-- è¡¨å•æ¨¡æ¿é¡µé¢ -->
<link rel="stylesheet" href="/frontend/static/css/templates-new.css">

<div class="templates-container">
    <!-- é¡¶éƒ¨å·¥å…·æ  -->
    <div class="toolbar">
        <div class="toolbar-left">
            <h1 class="page-title">è¡¨å•æ¨¡æ¿</h1>
        </div>
        <div class="toolbar-right">
            <!-- ç­›é€‰æ§ä»¶ -->
            <div class="filter-group" style="display: inline-flex; gap: 8px; margin-right: 16px;">
                <select id="fieldCountFilter" class="filter-select">
                    <option value="">å…¨éƒ¨å­—æ®µæ•°</option>
                    <option value="1-5">1-5ä¸ªå­—æ®µ</option>
                    <option value="6-10">6-10ä¸ªå­—æ®µ</option>
                    <option value="11-20">11-20ä¸ªå­—æ®µ</option>
                    <option value="20+">20+ä¸ªå­—æ®µ</option>
                </select>
                <input type="date" id="templateStartDateFilter" class="filter-input" placeholder="èµ·å§‹æ—¶é—´">
                <input type="date" id="templateEndDateFilter" class="filter-input" placeholder="ç»ˆæ­¢æ—¶é—´">
                <button id="templateFilterBtn" class="btn-secondary">ç­›é€‰</button>
                <button id="templateResetFilterBtn" class="btn-secondary">é‡ç½®</button>
            </div>
            <button class="btn-primary" onclick="TemplatesPage.openCreateModal()">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
                </svg>
                æ–°å»ºæ¨¡æ¿
            </button>
        </div>
    </div>

    <!-- æ¨¡æ¿åˆ—è¡¨è¡¨æ ¼ -->
    <div class="table-card">
        <div id="templatesTableContainer">
            <!-- è¡¨æ ¼å†…å®¹å°†é€šè¿‡ JS åŠ¨æ€åŠ è½½ -->
        </div>
    </div>
</div>

<!-- æ¨¡æ¿æè¿°æ¨¡æ€æ¡† -->
<div id="templateDescModal" class="modal-overlay" style="display: none;">
    <div class="modal" style="max-width: 500px;">
        <div class="modal-header">
            <h3 class="modal-title" id="templateDescModalTitle">æ¨¡æ¿æè¿°</h3>
            <button class="close-btn" onclick="TemplatesPage.closeTemplateDescModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <div id="templateDescContent" style="color: #666; line-height: 1.6;">
                <!-- æè¿°å†…å®¹å°†é€šè¿‡ JS åŠ¨æ€åŠ è½½ -->
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="TemplatesPage.closeTemplateDescModal()">å…³é—­</button>
        </div>
    </div>
</div>

<!-- å­—æ®µè¯¦æƒ…æ¨¡æ€æ¡† -->
<div id="fieldDetailModal" class="modal-overlay" style="display: none;">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title" id="fieldDetailModalTitle">æ¨¡æ¿å­—æ®µè¯¦æƒ…</h3>
            <button class="close-btn" onclick="TemplatesPage.closeFieldDetailModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <div id="fieldDetailContent" class="field-detail-list">
                <!-- å­—æ®µè¯¦æƒ…å°†é€šè¿‡ JS åŠ¨æ€åŠ è½½ -->
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="TemplatesPage.closeFieldDetailModal()">å…³é—­</button>
        </div>
    </div>
</div>

<!-- åˆ›å»º/ç¼–è¾‘æ¨¡æ¿æ¨¡æ€æ¡† -->
<div id="templateFormModal" class="modal-overlay" style="display: none;">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title" id="templateFormModalTitle">æ–°å»ºæ¨¡æ¿</h3>
            <button class="close-btn" onclick="TemplatesPage.closeTemplateFormModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <form id="templateForm">
                <!-- Excelå¯¼å…¥ -->
                <div class="form-group" id="excelUploadSection">
                    <label class="form-label">ä» Excel å¯¼å…¥æ¨¡æ¿</label>
                    <input type="file" id="excelFileInput" accept=".xlsx,.xls" 
                           style="display: none;" onchange="TemplatesPage.handleExcelUpload(event)">
                    <div class="excel-upload-area" onclick="document.getElementById('excelFileInput').click()">
                        <div class="upload-icon">ğŸ“¤</div>
                        <div class="upload-text">ç‚¹å‡»ä¸Šä¼  Excel æ–‡ä»¶</div>
                        <div class="upload-hint" id="excelFileName">æ”¯æŒ .xlsx å’Œ .xls æ ¼å¼</div>
                    </div>
                </div>

                <!-- åŸºæœ¬ä¿¡æ¯ -->
                <div class="form-group">
                    <label class="form-label">
                        æ¨¡æ¿åç§° <span class="required">*</span>
                    </label>
                    <input type="text" class="form-input" id="templateName" 
                           placeholder="è¯·è¾“å…¥æ¨¡æ¿åç§°" required maxlength="100">
                </div>

                <div class="form-group">
                    <label class="form-label">æ¨¡æ¿æè¿°</label>
                    <textarea class="form-input form-textarea" id="templateDescription" 
                              placeholder="è¯·è¾“å…¥æ¨¡æ¿æè¿°ï¼ˆå¯é€‰ï¼‰"></textarea>
                </div>

                <!-- å­—æ®µç®¡ç† -->
                <div class="fields-section">
                    <div class="fields-header">
                        <span class="fields-title">è¡¨å•å­—æ®µ</span>
                        <button type="button" class="add-field-btn" onclick="TemplatesPage.addField()">
                            <i>â•</i> æ·»åŠ å­—æ®µ
                        </button>
                    </div>
                    <div id="fieldsList" class="fields-list">
                        <!-- å­—æ®µåˆ—è¡¨å°†é€šè¿‡ JS åŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="TemplatesPage.closeTemplateFormModal()">å–æ¶ˆ</button>
            <button class="btn btn-primary" onclick="TemplatesPage.saveTemplate()">ä¿å­˜</button>
        </div>
    </div>
</div>

<script src="/frontend/static/js/api/templates.js"></script>
<script>
// ä½¿ç”¨ IIFE é¿å…å…¨å±€å˜é‡æ±¡æŸ“ï¼Œæ¯æ¬¡åŠ è½½é¡µé¢æ—¶åˆ›å»ºæ–°å®ä¾‹
(function() {
const TemplatesPage = (() => {
    // ç§æœ‰å˜é‡
    let templates = [];
    let filteredTemplates = [];
    let currentTemplate = null;
    let editingTemplateId = null;
    let draggedElement = null;
    let fieldCounter = 0;
    let sortBy = 'created_at';
    let sortOrder = 'desc';
    let filters = {
        fieldCount: '',
        startDate: '',
        endDate: ''
    };

    // å­—æ®µç±»å‹é€‰é¡¹
    const fieldTypes = [
        { value: 'TEXT', label: 'æ–‡æœ¬' },
        { value: 'NUMBER', label: 'æ•°å­—' },
        { value: 'DATE', label: 'æ—¥æœŸ' },
        { value: 'TIME', label: 'æ—¶é—´' },
        { value: 'BOOLEAN', label: 'æ˜¯/å¦' },
        { value: 'RADIO', label: 'å•é€‰' },
        { value: 'CHECKBOX', label: 'å¤šé€‰' }
    ];

    // ==================== åˆå§‹åŒ– ====================
    async function init() {
        await loadTemplates();
        bindSortEvents();
        bindFilterEvents();
    }

    function bindSortEvents() {
        // å»¶è¿Ÿç»‘å®šï¼Œç¡®ä¿DOMå·²æ¸²æŸ“
        setTimeout(() => {
            document.querySelectorAll('.sortable').forEach(th => {
                th.addEventListener('click', () => {
                    const sortByField = th.dataset.sort;
                    handleSort(sortByField);
                });
            });
        }, 100);
    }

    function bindFilterEvents() {
        const filterBtn = document.getElementById('templateFilterBtn');
        const resetBtn = document.getElementById('templateResetFilterBtn');
        const startDateInput = document.getElementById('templateStartDateFilter');
        const endDateInput = document.getElementById('templateEndDateFilter');
        
        if (filterBtn) {
            filterBtn.addEventListener('click', applyFilters);
        }
        
        if (resetBtn) {
            resetBtn.addEventListener('click', resetFilters);
        }
        
        // è®¾ç½®ä¸­æ–‡placeholder
        if (startDateInput && !startDateInput.value) {
            startDateInput.setAttribute('data-placeholder', 'èµ·å§‹æ—¶é—´ï¼ˆå¹´-æœˆ-æ—¥ï¼‰');
        }
        if (endDateInput && !endDateInput.value) {
            endDateInput.setAttribute('data-placeholder', 'ç»ˆæ­¢æ—¶é—´ï¼ˆå¹´-æœˆ-æ—¥ï¼‰');
        }
        
        [startDateInput, endDateInput].forEach(input => {
            if (input) {
                input.addEventListener('change', function() {
                    if (this.value) {
                        const date = new Date(this.value);
                        const year = date.getFullYear();
                        const month = String(date.getMonth() + 1).padStart(2, '0');
                        const day = String(date.getDate()).padStart(2, '0');
                        this.setAttribute('data-value', `${year}å¹´${month}æœˆ${day}æ—¥`);
                    }
                });
            }
        });
    }

    // ==================== ç­›é€‰åŠŸèƒ½ ====================
    
    function applyFilters() {
        filters.fieldCount = document.getElementById('fieldCountFilter').value;
        filters.startDate = document.getElementById('templateStartDateFilter').value;
        filters.endDate = document.getElementById('templateEndDateFilter').value;
        
        filteredTemplates = templates.filter(template => {
            // å­—æ®µæ•°é‡ç­›é€‰
            if (filters.fieldCount) {
                const fieldCount = template.field_count || 0;
                if (filters.fieldCount === '1-5' && (fieldCount < 1 || fieldCount > 5)) {
                    return false;
                }
                if (filters.fieldCount === '6-10' && (fieldCount < 6 || fieldCount > 10)) {
                    return false;
                }
                if (filters.fieldCount === '11-20' && (fieldCount < 11 || fieldCount > 20)) {
                    return false;
                }
                if (filters.fieldCount === '20+' && fieldCount <= 20) {
                    return false;
                }
            }
            
            // èµ·å§‹æ—¶é—´ç­›é€‰
            if (filters.startDate && template.created_at) {
                const templateDate = new Date(template.created_at).toISOString().split('T')[0];
                if (templateDate < filters.startDate) {
                    return false;
                }
            }
            
            // ç»ˆæ­¢æ—¶é—´ç­›é€‰
            if (filters.endDate && template.created_at) {
                const templateDate = new Date(template.created_at).toISOString().split('T')[0];
                if (templateDate > filters.endDate) {
                    return false;
                }
            }
            
            return true;
        });
        
        sortAndRenderTemplates();
    }
    
    function resetFilters() {
        document.getElementById('fieldCountFilter').value = '';
        document.getElementById('templateStartDateFilter').value = '';
        document.getElementById('templateEndDateFilter').value = '';
        filters = {
            fieldCount: '',
            startDate: '',
            endDate: ''
        };
        filteredTemplates = [];
        sortAndRenderTemplates();
    }

    // ==================== æ¨¡æ¿åˆ—è¡¨ ====================
    
    async function loadTemplates() {
        const container = document.getElementById('templatesTableContainer');
        container.innerHTML = '<div class="loading-container"><div class="loading-spinner"></div></div>';

        try {
            templates = await TemplateAPI.getTemplates();
            sortAndRenderTemplates();
        } catch (error) {
            console.error('åŠ è½½æ¨¡æ¿åˆ—è¡¨å¤±è´¥:', error);
            container.innerHTML = `
                <div class="empty-state">
                    <i>âš ï¸</i>
                    <p>åŠ è½½å¤±è´¥: ${error.message}</p>
                    <button class="btn btn-primary" onclick="TemplatesPage.loadTemplates()">é‡è¯•</button>
                </div>
            `;
        }
    }

    function sortAndRenderTemplates() {
        const templatesToSort = filteredTemplates.length > 0 || filters.fieldCount || filters.startDate || filters.endDate
            ? filteredTemplates
            : templates;
        
        const sorted = [...templatesToSort].sort((a, b) => {
            let aVal = a[sortBy];
            let bVal = b[sortBy];

            // å¤„ç†null/undefinedå€¼
            if (aVal == null) aVal = '';
            if (bVal == null) bVal = '';

            // å­—ç¬¦ä¸²æ¯”è¾ƒ
            if (typeof aVal === 'string') {
                const result = aVal.localeCompare(bVal);
                return sortOrder === 'asc' ? result : -result;
            }

            // æ•°å­—/æ—¥æœŸæ¯”è¾ƒ
            if (sortOrder === 'asc') {
                return aVal > bVal ? 1 : -1;
            } else {
                return aVal < bVal ? 1 : -1;
            }
        });

        renderTemplateList(sorted);
        updateSortUI();
    }

    function handleSort(sortByField) {
        if (sortBy === sortByField) {
            sortOrder = sortOrder === 'asc' ? 'desc' : 'asc';
        } else {
            sortBy = sortByField;
            sortOrder = 'desc';
        }
        sortAndRenderTemplates();
    }

    function updateSortUI() {
        document.querySelectorAll('.sortable').forEach(th => {
            th.classList.remove('active');
            const icon = th.querySelector('.sort-icon');
            if (icon) icon.textContent = 'â‡…';
        });

        const activeTh = document.querySelector(`[data-sort="${sortBy}"]`);
        if (activeTh) {
            activeTh.classList.add('active');
            const icon = activeTh.querySelector('.sort-icon');
            if (icon) icon.textContent = sortOrder === 'asc' ? 'â–²' : 'â–¼';
        }
    }

    function renderTemplateList(sortedTemplates = templates) {
        const container = document.getElementById('templatesTableContainer');

        if (sortedTemplates.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ“‹</div>
                    <div class="empty-state-text">æš‚æ— æ¨¡æ¿ï¼Œç‚¹å‡»å³ä¸Šè§’åˆ›å»ºæ–°æ¨¡æ¿</div>
                </div>
            `;
            return;
        }

        const tableHTML = `
            <table class="templates-table">
                <thead>
                    <tr>
                        <th class="col-name sortable" data-sort="name">
                            æ¨¡æ¿åç§°
                            <span class="sort-icon">â‡…</span>
                        </th>
                        <th class="col-count sortable" data-sort="field_count">
                            å­—æ®µæ•°é‡
                            <span class="sort-icon">â‡…</span>
                        </th>
                        <th class="col-time sortable active" data-sort="created_at">
                            åˆ›å»ºæ—¶é—´
                            <span class="sort-icon">â–¼</span>
                        </th>
                        <th class="col-actions">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    ${sortedTemplates.map(template => `
                        <tr>
                            <td class="col-name">
                                <a href="#" class="template-name-link" onclick="TemplatesPage.viewTemplateDesc(${template.id}, '${escapeHtml(template.name)}', '${escapeHtml(template.description || '')}'); return false;">
                                    ${escapeHtml(template.name)}
                                </a>
                            </td>
                            <td class="col-count">
                                <a href="#" class="field-count-link" onclick="TemplatesPage.viewTemplateFields(${template.id}); return false;">${template.field_count}</a>
                            </td>
                            <td class="col-time">${formatDateTime(template.created_at)}</td>
                            <td class="col-actions">
                                <div class="action-buttons">
                                    <button class="btn-secondary btn-sm" onclick="TemplatesPage.openEditModal(${template.id})">
                                        ç¼–è¾‘
                                    </button>
                                    <button class="btn-danger btn-sm" onclick="TemplatesPage.deleteTemplate(${template.id})">
                                        åˆ é™¤
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;

        container.innerHTML = tableHTML;
        
        // é‡æ–°ç»‘å®šæ’åºäº‹ä»¶
        bindSortEvents();
    }

    // ==================== æŸ¥çœ‹æ¨¡æ¿æè¿° ====================
    
    function viewTemplateDesc(templateId, templateName, description) {
        document.getElementById('templateDescModalTitle').textContent = templateName;
        const content = document.getElementById('templateDescContent');
        
        if (description && description !== 'null' && description.trim()) {
            content.textContent = description;
        } else {
            content.innerHTML = '<p style="color: #bbb;">æš‚æ— æè¿°</p>';
        }
        
        document.getElementById('templateDescModal').style.display = 'flex';
    }
    
    function closeTemplateDescModal() {
        document.getElementById('templateDescModal').style.display = 'none';
    }

    // ==================== æŸ¥çœ‹å­—æ®µè¯¦æƒ… ====================
    
    async function viewTemplateFields(templateId) {
        try {
            const template = await TemplateAPI.getTemplateDetail(templateId);
            currentTemplate = template;

            document.getElementById('fieldDetailModalTitle').textContent = `${template.name} - å­—æ®µè¯¦æƒ…`;

            const content = document.getElementById('fieldDetailContent');

            if (template.fields.length === 0) {
                content.innerHTML = `
                    <div class="empty-state">
                        <p>è¯¥æ¨¡æ¿æš‚æ— å­—æ®µ</p>
                    </div>
                `;
            } else {
                content.innerHTML = template.fields.map(field => `
                    <div class="field-detail-item">
                        <div class="field-detail-header">
                            <span class="field-detail-name">${escapeHtml(field.display_name)}</span>
                            ${field.required ? '<span class="field-detail-required">å¿…å¡«</span>' : ''}
                        </div>
                        <div class="field-detail-info">
                            <span class="field-detail-type">${getFieldTypeLabel(field.data_type)}</span>
                        </div>
                    </div>
                `).join('');
            }

            document.getElementById('fieldDetailModal').style.display = 'flex';
        } catch (error) {
            console.error('åŠ è½½æ¨¡æ¿è¯¦æƒ…å¤±è´¥:', error);
            alert('åŠ è½½æ¨¡æ¿è¯¦æƒ…å¤±è´¥: ' + error.message);
        }
    }

    function closeFieldDetailModal() {
        document.getElementById('fieldDetailModal').style.display = 'none';
        currentTemplate = null;
    }

    // ==================== Excel ä¸Šä¼ å¤„ç† ====================
    
    async function handleExcelUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const fileNameSpan = document.getElementById('excelFileName');
        fileNameSpan.textContent = 'æ­£åœ¨è§£æ...';
        fileNameSpan.className = 'upload-hint loading';
        
        try {
            const result = await TemplateAPI.parseExcel(file);
            
            // å¡«å……æ¨¡æ¿åç§°
            if (result.template_name) {
                document.getElementById('templateName').value = result.template_name;
            }
            
            // æ¸…ç©ºç°æœ‰å­—æ®µ
            document.getElementById('fieldsList').innerHTML = '';
            fieldCounter = 0;
            
            // æ·»åŠ è§£æå‡ºçš„å­—æ®µ
            if (result.fields && result.fields.length > 0) {
                result.fields.forEach(field => {
                    addField({
                        display_name: field.display_name,
                        data_type: field.data_type,
                        required: field.required
                    });
                });
            }
            
            fileNameSpan.textContent = `âœ“ å·²å¯¼å…¥ ${result.fields.length} ä¸ªå­—æ®µ`;
            fileNameSpan.className = 'upload-hint success';
            
            // 3ç§’åæ¢å¤æç¤ºæ–‡æœ¬
            setTimeout(() => {
                fileNameSpan.textContent = 'æ”¯æŒ .xlsx å’Œ .xls æ ¼å¼';
                fileNameSpan.className = 'upload-hint';
            }, 3000);
        } catch (error) {
            console.error('è§£æ Excel å¤±è´¥:', error);
            fileNameSpan.textContent = 'âœ— è§£æå¤±è´¥: ' + error.message;
            fileNameSpan.className = 'upload-hint error';
            
            setTimeout(() => {
                fileNameSpan.textContent = 'æ”¯æŒ .xlsx å’Œ .xls æ ¼å¼';
                fileNameSpan.className = 'upload-hint';
            }, 3000);
        }
        
        // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©
        event.target.value = '';
    }

    // ==================== åˆ›å»ºæ¨¡æ¿ ====================
    
    function openCreateModal() {
        editingTemplateId = null;
        fieldCounter = 0;

        document.getElementById('templateFormModalTitle').textContent = 'æ–°å»ºæ¨¡æ¿';
        document.getElementById('templateName').value = '';
        document.getElementById('templateDescription').value = '';
        document.getElementById('fieldsList').innerHTML = '';
        document.getElementById('excelUploadSection').style.display = 'block';

        // é»˜è®¤æ·»åŠ ä¸€ä¸ªå­—æ®µ
        addField();

        document.getElementById('templateFormModal').style.display = 'flex';
    }

    // ==================== ç¼–è¾‘æ¨¡æ¿ ====================
    
    async function openEditModal(templateId) {
        try {
            const template = await TemplateAPI.getTemplateDetail(templateId);
            editingTemplateId = templateId;
            currentTemplate = template;
            fieldCounter = 0;

            document.getElementById('templateFormModalTitle').textContent = 'ç¼–è¾‘æ¨¡æ¿';
            document.getElementById('templateName').value = template.name;
            document.getElementById('templateDescription').value = template.description || '';
            document.getElementById('excelUploadSection').style.display = 'none';

            // æ¸²æŸ“ç°æœ‰å­—æ®µ
            const fieldsList = document.getElementById('fieldsList');
            fieldsList.innerHTML = '';

            template.fields.forEach(field => {
                addField(field);
            });

            document.getElementById('templateFormModal').style.display = 'flex';
        } catch (error) {
            console.error('åŠ è½½æ¨¡æ¿è¯¦æƒ…å¤±è´¥:', error);
            alert('åŠ è½½æ¨¡æ¿è¯¦æƒ…å¤±è´¥: ' + error.message);
        }
    }

    function closeTemplateFormModal() {
        document.getElementById('templateFormModal').style.display = 'none';
        editingTemplateId = null;
        currentTemplate = null;
    }

    // ==================== å­—æ®µç®¡ç† ====================
    
    function addField(fieldData = null) {
        const fieldId = fieldCounter++;
        const fieldsList = document.getElementById('fieldsList');

        const fieldItem = document.createElement('div');
        fieldItem.className = 'field-item';
        fieldItem.draggable = true;
        fieldItem.dataset.fieldId = fieldId;

        fieldItem.innerHTML = `
            <div class="field-inline">
                <span class="drag-handle" title="æ‹–åŠ¨æ’åº">â˜°</span>
                <span class="field-number">#${fieldsList.children.length + 1}</span>
                <input type="text" class="form-input" name="field_name_${fieldId}" 
                       placeholder="å­—æ®µåç§°" required maxlength="100"
                       value="${fieldData ? escapeHtml(fieldData.display_name) : ''}">
                <select class="form-select" name="field_type_${fieldId}" required>
                    ${fieldTypes.map(type => `
                        <option value="${type.value}" ${fieldData && fieldData.data_type === type.value ? 'selected' : ''}>
                            ${type.label}
                        </option>
                    `).join('')}
                </select>
                <div class="form-checkbox-wrapper">
                    <input type="checkbox" id="field_required_${fieldId}" name="field_required_${fieldId}"
                           class="form-checkbox-input" ${fieldData && fieldData.required ? 'checked' : ''}>
                    <label for="field_required_${fieldId}" class="form-checkbox-label">
                        <span class="checkbox-box"></span>
                        <span class="checkbox-text">å¿…å¡«</span>
                    </label>
                </div>
                <button type="button" class="field-control-btn delete" onclick="TemplatesPage.removeField(${fieldId})" title="åˆ é™¤å­—æ®µ">
                    Ã—
                </button>
            </div>
        `;

        // æ·»åŠ æ‹–æ‹½äº‹ä»¶
        fieldItem.addEventListener('dragstart', handleDragStart);
        fieldItem.addEventListener('dragover', handleDragOver);
        fieldItem.addEventListener('drop', handleDrop);
        fieldItem.addEventListener('dragend', handleDragEnd);

        fieldsList.appendChild(fieldItem);
        updateFieldNumbers();
    }

    function removeField(fieldId) {
        const fieldItem = document.querySelector(`[data-field-id="${fieldId}"]`);
        if (fieldItem) {
            fieldItem.remove();
            updateFieldNumbers();
        }
    }

    function updateFieldNumbers() {
        const fieldItems = document.querySelectorAll('.field-item');
        fieldItems.forEach((item, index) => {
            const numberSpan = item.querySelector('.field-number');
            if (numberSpan) {
                numberSpan.textContent = index + 1;
            }
        });
    }

    // ==================== æ‹–æ‹½æ’åº ====================
    
    function handleDragStart(e) {
        draggedElement = this;
        this.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
    }

    function handleDragOver(e) {
        if (e.preventDefault) {
            e.preventDefault();
        }
        e.dataTransfer.dropEffect = 'move';

        const afterElement = getDragAfterElement(e.clientY);
        const fieldsList = document.getElementById('fieldsList');

        if (afterElement == null) {
            fieldsList.appendChild(draggedElement);
        } else {
            fieldsList.insertBefore(draggedElement, afterElement);
        }

        return false;
    }

    function handleDrop(e) {
        if (e.stopPropagation) {
            e.stopPropagation();
        }
        updateFieldNumbers();
        return false;
    }

    function handleDragEnd(e) {
        this.classList.remove('dragging');
        draggedElement = null;
    }

    function getDragAfterElement(y) {
        const fieldsList = document.getElementById('fieldsList');
        const draggableElements = [...fieldsList.querySelectorAll('.field-item:not(.dragging)')];

        return draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;

            if (offset < 0 && offset > closest.offset) {
                return { offset: offset, element: child };
            } else {
                return closest;
            }
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    // ==================== ä¿å­˜æ¨¡æ¿ ====================
    
    async function saveTemplate() {
        const name = document.getElementById('templateName').value.trim();
        const description = document.getElementById('templateDescription').value.trim();

        if (!name) {
            alert('è¯·è¾“å…¥æ¨¡æ¿åç§°');
            return;
        }

        // æ”¶é›†å­—æ®µæ•°æ®
        const fieldItems = document.querySelectorAll('.field-item');
        if (fieldItems.length === 0) {
            alert('è¯·è‡³å°‘æ·»åŠ ä¸€ä¸ªå­—æ®µ');
            return;
        }

        const fields = [];
        let hasError = false;

        fieldItems.forEach((item, index) => {
            const fieldId = item.dataset.fieldId;
            const fieldName = document.querySelector(`[name="field_name_${fieldId}"]`).value.trim();
            const fieldType = document.querySelector(`[name="field_type_${fieldId}"]`).value;
            const fieldRequired = document.querySelector(`[name="field_required_${fieldId}"]`).checked;

            if (!fieldName) {
                alert(`ç¬¬ ${index + 1} ä¸ªå­—æ®µçš„åç§°ä¸èƒ½ä¸ºç©º`);
                hasError = true;
                return;
            }

            fields.push({
                display_name: fieldName,
                data_type: fieldType,
                required: fieldRequired,
                ord: index  // ç›´æ¥ä½¿ç”¨indexä½œä¸ºordï¼Œä»0å¼€å§‹
            });
        });

        if (hasError) {
            return;
        }

        const data = {
            name: name,
            description: description || null,
            fields: fields
        };

        try {
            if (editingTemplateId) {
                await TemplateAPI.updateTemplate(editingTemplateId, data);
                alert('æ¨¡æ¿æ›´æ–°æˆåŠŸ');
            } else {
                await TemplateAPI.createTemplate(data);
                alert('æ¨¡æ¿åˆ›å»ºæˆåŠŸ');
            }

            closeTemplateFormModal();
            await loadTemplates();
        } catch (error) {
            console.error('ä¿å­˜æ¨¡æ¿å¤±è´¥:', error);
            alert('ä¿å­˜å¤±è´¥: ' + error.message);
        }
    }

    // ==================== åˆ é™¤æ¨¡æ¿ ====================
    
    async function deleteTemplate(templateId) {
        if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ¨¡æ¿å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
            return;
        }

        try {
            await TemplateAPI.deleteTemplate(templateId);
            alert('æ¨¡æ¿åˆ é™¤æˆåŠŸ');
            await loadTemplates();
        } catch (error) {
            console.error('åˆ é™¤æ¨¡æ¿å¤±è´¥:', error);
            alert('åˆ é™¤å¤±è´¥: ' + error.message);
        }
    }

    // ==================== å·¥å…·å‡½æ•° ====================
    
    function formatDateTime(dateString) {
        const date = new Date(dateString);
        return date.toLocaleString('zh-CN', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function getFieldTypeLabel(type) {
        const typeObj = fieldTypes.find(t => t.value === type);
        return typeObj ? typeObj.label : type;
    }

    // ==================== å…¬å¼€æ¥å£ ====================
    
    return {
        init,
        loadTemplates,
        viewTemplateDesc,
        closeTemplateDescModal,
        viewTemplateFields,
        closeFieldDetailModal,
        openCreateModal,
        openEditModal,
        closeTemplateFormModal,
        handleExcelUpload,
        addField,
        removeField,
        saveTemplate,
        deleteTemplate
    };
})();

// å°† TemplatesPage æš´éœ²åˆ°å…¨å±€ä¾› onclick ä½¿ç”¨
window.TemplatesPage = TemplatesPage;

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
TemplatesPage.init();
})();
</script>
