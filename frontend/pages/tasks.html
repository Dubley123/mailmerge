<!-- ä»»åŠ¡æ€»è§ˆé¡µé¢ -->
<link rel="stylesheet" href="/frontend/static/css/tasks-new.css?v=e958b87d">

<!-- å¼•å…¥å¿…è¦çš„JSæ–‡ä»¶ -->
<script src="/frontend/static/js/utils.js?v=63a5e164"></script>
<script src="/frontend/static/js/api/common.js?v=ce134e28"></script>
<script src="/frontend/static/js/api/tasks.js?v=01d77330"></script>

<div class="tasks-container">
    <h1 class="page-title">ä»»åŠ¡æ€»è§ˆ</h1>
    <!-- é¡¶éƒ¨å·¥å…·æ  -->
    <div class="toolbar">
        <div class="toolbar-left">
            <!-- ç­›é€‰æ§ä»¶ -->
            <div class="filter-group" style="display: inline-flex; gap: 8px;">
                <span style="font-size: 14px; color: #374151; margin-left: 8px;">åˆ›å»ºæ—¶é—´èŒƒå›´</span>
                <input type="date" id="startDateFilter" class="filter-input" placeholder="èµ·å§‹æ—¶é—´">
                <span style="color: #9CA3AF;">â€”</span>
                <input type="date" id="endDateFilter" class="filter-input" placeholder="ç»ˆæ­¢æ—¶é—´">
                <select id="statusFilter" class="filter-select">
                    <option value="">å…¨éƒ¨çŠ¶æ€</option>
                    <option value="DRAFT">æœªå‘å¸ƒ</option>
                    <option value="ACTIVE">å·²å‘å¸ƒ</option>
                    <option value="EXPIRED">è¶…æ—¶æœªå…³é—­</option>
                    <option value="CLOSED">å·²å…³é—­</option>
                </select>
                <input type="text" id="taskNameFilter" class="filter-input" placeholder="è¾“å…¥ä»»åŠ¡åç§°">
                <button id="filterBtn" class="btn-secondary">ç­›é€‰</button>
                <button id="resetFilterBtn" class="btn-secondary">é‡ç½®</button>
            </div>
        </div>
        <div class="toolbar-right">
            <button id="refreshTaskBtn" class="btn-secondary" onclick="TasksPage.loadTasks()" style="margin-right: 8px;">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>
                    <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
                </svg>
                åˆ·æ–°
            </button>
            <button class="btn-primary" onclick="TasksPage.openCreateModal()">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
                </svg>
                æ–°å»ºä»»åŠ¡
            </button>
        </div>
    </div>

    <!-- ä»»åŠ¡åˆ—è¡¨è¡¨æ ¼ -->
    <div class="table-card">
        <table class="tasks-table">
            <thead>
                <tr>
                    <th class="col-name sortable" data-sort="name">
                        ä»»åŠ¡åç§°
                        <span class="sort-icon">â‡…</span>
                    </th>
                    <th class="col-created sortable" data-sort="created_at">
                        åˆ›å»ºæ—¶é—´
                        <span class="sort-icon">â‡…</span>
                    </th>
                    <th class="col-time sortable" data-sort="started_time">
                        èµ·å§‹æ—¶é—´
                        <span class="sort-icon">â‡…</span>
                    </th>
                    <th class="col-time sortable active" data-sort="deadline">
                        ç»ˆæ­¢æ—¶é—´
                        <span class="sort-icon">â–¼</span>
                    </th>
                    <th class="col-template">è¡¨æ ¼æ¨¡æ¿</th>
                    <th class="col-count">å·²å›å¤/æ€»æ•°</th>
                    <th class="col-status sortable" data-sort="status">
                        çŠ¶æ€
                        <span class="sort-icon">â‡…</span>
                    </th>
                    <th class="col-actions">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="tasksTableBody">
                <tr>
                    <td colspan="8" class="loading-state">åŠ è½½ä¸­...</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- ä»»åŠ¡æè¿°å¼¹çª— -->
<div id="taskDescModal" class="modal-overlay" style="display: none;">
    <div class="modal modal-detail">
        <div class="modal-header">
            <h2 class="modal-title" id="taskDescTitle">ä»»åŠ¡æè¿°</h2>
            <button class="modal-close" onclick="TasksPage.closeDescModal()">&times;</button>
        </div>
        <div class="modal-body">
            <p id="taskDescContent" style="line-height: 1.8; color: #4B5563;"></p>
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" onclick="TasksPage.closeDescModal()">å…³é—­</button>
        </div>
    </div>
</div>

<!-- ä»»åŠ¡è¯¦æƒ…å¼¹çª— -->
<div id="taskDetailModal" class="modal-overlay" style="display: none;">
    <div class="modal modal-detail">
        <div class="modal-header">
            <h2 class="modal-title">ä»»åŠ¡å›å¤è¯¦æƒ…</h2>
            <button class="modal-close" onclick="TasksPage.closeDetailModal()">&times;</button>
        </div>
        <div class="modal-body">
            <table class="detail-table">
                <thead>
                    <tr>
                        <th>æ•™å¸ˆå§“å</th>
                        <th>å·¥å·</th>
                        <th>é‚®ç®±</th>
                        <th>å›å¤çŠ¶æ€</th>
                    </tr>
                </thead>
                <tbody id="taskDetailTableBody"></tbody>
            </table>
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" onclick="TasksPage.closeDetailModal()">å…³é—­</button>
        </div>
    </div>
</div>

<!-- æ–°å»º/ç¼–è¾‘ä»»åŠ¡å¼¹çª— -->
<div id="taskFormModal" class="modal-overlay" style="display: none;">
    <div class="modal modal-create">
        <div class="modal-header">
            <h2 class="modal-title" id="taskFormTitle">æ–°å»ºä»»åŠ¡</h2>
            <button class="modal-close" onclick="TasksPage.closeFormModal()">&times;</button>
        </div>
        <div class="modal-body">
            <!-- æ­¥éª¤è¿›åº¦æ¡ -->
            <div class="step-progress" id="stepProgress">
                <div class="step-item active" data-step="1">
                    <div class="step-circle">1</div>
                    <div class="step-label">åŸºç¡€ä¿¡æ¯</div>
                </div>
                <div class="step-item" data-step="2">
                    <div class="step-circle">2</div>
                    <div class="step-label">æ¨¡æ¿ä¸é‚®ä»¶</div>
                </div>
                <div class="step-item" data-step="3">
                    <div class="step-circle">3</div>
                    <div class="step-label">æ•™å¸ˆåˆ—è¡¨</div>
                </div>
            </div>

            <form id="taskForm">
                <!-- æ­¥éª¤1: åŸºç¡€ä¿¡æ¯ -->
                <div class="form-section active" id="step1">
                    <div class="form-group">
                        <label class="form-label form-label-required">ä»»åŠ¡åç§°</label>
                        <input type="text" class="form-input" id="taskName" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ä»»åŠ¡æè¿°</label>
                        <textarea class="form-textarea" id="taskDesc" placeholder="å¯é€‰ï¼Œç”¨äºè¯´æ˜æœ¬æ¬¡ä»»åŠ¡çš„ç›®çš„å’Œè¦æ±‚"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label form-label-required">æˆªæ­¢æ—¶é—´</label>
                        <input type="datetime-local" class="form-input" id="taskDeadline" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label form-label-required">å‘å¸ƒæ—¶é—´</label>
                        <div class="form-radio-group">
                            <label class="form-radio">
                                <input type="radio" name="publishType" value="now" checked>
                                <span>ç«‹å³å‘å¸ƒ</span>
                            </label>
                            <label class="form-radio">
                                <input type="radio" name="publishType" value="scheduled">
                                <span>è‡ªå®šä¹‰æ—¶é—´</span>
                            </label>
                        </div>
                        <input type="datetime-local" class="form-input" id="taskStartTime" style="display: none; margin-top: 8px;">
                    </div>
                </div>

                <!-- æ­¥éª¤2: æ¨¡æ¿ä¸é‚®ä»¶ -->
                <div class="form-section" id="step2">
                    <div class="form-group">
                        <label class="form-label form-label-required">è¡¨æ ¼æ¨¡æ¿</label>
                        <select class="form-select" id="taskTemplate" required>
                            <option value="">è¯·é€‰æ‹©æ¨¡æ¿</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label form-label-required">é‚®ä»¶æ ‡é¢˜</label>
                        <input type="text" class="form-input" id="mailSubject" placeholder="ä¾‹å¦‚ï¼šè¯·å¡«å†™2024å¹´åº¦ç§‘ç ”æ•°æ®" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label form-label-required">é‚®ä»¶æ­£æ–‡</label>
                        <textarea class="form-textarea" id="mailContent" placeholder="é‚®ä»¶æ­£æ–‡å†…å®¹ï¼Œå¯ä½¿ç”¨å˜é‡ï¼š{æ•™å¸ˆå§“å}ã€{ä»»åŠ¡åç§°}ã€{æˆªæ­¢æ—¶é—´}" required style="min-height: 150px;"></textarea>
                    </div>
                </div>

                <!-- æ­¥éª¤3: æ•™å¸ˆåˆ—è¡¨ -->
                <div class="form-section" id="step3">
                    <!-- æœç´¢æ¡†å’Œå…¨é€‰æŒ‰é’®åœ¨åŒä¸€è¡Œ -->
                    <div class="teacher-search-bar">
                        <input type="text" class="teacher-search-input" id="teacherSearch" placeholder="æœç´¢æ•™å¸ˆå§“åã€å·¥å·æˆ–é‚®ç®±...">
                        <div class="toggle-wrapper">
                            <span class="toggle-label">å…¨é€‰</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="selectAllTeachers">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                    <!-- é€‰ä¸­æ•°é‡æ˜¾ç¤º -->
                    <div class="selected-count-display">
                        <span id="selectedCount">å·²é€‰æ‹©: 0</span>
                    </div>
                    <!-- æ•™å¸ˆåˆ—è¡¨è¡¨æ ¼ -->
                    <div style="max-height: 300px; overflow-y: auto; border: 1px solid #E5E7EB; border-radius: 6px;">
                        <table class="detail-table">
                            <thead>
                                <tr>
                                    <th style="width: 25%">å§“å</th>
                                    <th style="width: 25%">å·¥å·</th>
                                    <th>é‚®ç®±</th>
                                </tr>
                            </thead>
                            <tbody id="teacherListBody"></tbody>
                        </table>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" id="btnPrev" onclick="TasksPage.prevStep()" style="display: none;">ä¸Šä¸€æ­¥</button>
            <button class="btn-primary" id="btnNext" onclick="TasksPage.nextStep()">ä¸‹ä¸€æ­¥</button>
            <button class="btn-primary" id="btnSubmit" onclick="TasksPage.submitTask()" style="display: none;">å®Œæˆ</button>
        </div>
    </div>
</div>

<script>
// ä»»åŠ¡é¡µé¢ç®¡ç†å¯¹è±¡
// ä½¿ç”¨ç«‹å³æ‰§è¡Œå‡½æ•°ç¡®ä¿æ¯æ¬¡åŠ è½½éƒ½æ˜¯æ–°çš„å®ä¾‹
(function() {
    const TasksPage = {
        currentStep: 1,
        isEditMode: false,
        editTaskId: null,
        allTeachers: [],
        selectedTeacherIds: new Set(), // è®°å½•é€‰ä¸­çš„æ•™å¸ˆID
        allTemplates: [],
        allTasks: [],
        filteredTasks: [],
        sortBy: 'deadline',
        sortOrder: 'desc',
        filters: {
            status: '',
            createdStart: '',
            createdEnd: '',
            keyword: ''
        },
        // åˆå§‹åŒ–é¡µé¢
        async init() {
            console.log('[Tasks] é¡µé¢åˆå§‹åŒ–å¼€å§‹');
            try {
                await this.loadTasks();
                await this.loadTemplates();
                await this.loadTeachers();
                this.bindEvents();
                console.log('[Tasks] é¡µé¢åˆå§‹åŒ–å®Œæˆ');
            } catch (error) {
                // åˆå§‹åŒ–å¤±è´¥æ—¶é¡µé¢ä¼šæ˜¾ç¤ºé”™è¯¯çŠ¶æ€
            }
        },

    // ç»‘å®šäº‹ä»¶
    bindEvents() {
        // æ’åºç‚¹å‡»äº‹ä»¶
        document.querySelectorAll('.sortable').forEach(th => {
            th.addEventListener('click', () => {
                const sortBy = th.dataset.sort;
                this.handleSort(sortBy);
            });
        });

        // å‘å¸ƒæ—¶é—´å•é€‰æ¡†åˆ‡æ¢
        document.querySelectorAll('input[name="publishType"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                const startTimeInput = document.getElementById('taskStartTime');
                startTimeInput.style.display = e.target.value === 'scheduled' ? 'block' : 'none';
                if (e.target.value === 'now') {
                    startTimeInput.value = '';
                }
            });
        });

        // å…¨é€‰æ•™å¸ˆ
        document.getElementById('selectAllTeachers').addEventListener('change', (e) => {
            this.toggleSelectAll(e.target.checked);
        });

        // æ•™å¸ˆæœç´¢
        document.getElementById('teacherSearch').addEventListener('input', (e) => {
            this.filterTeachers(e.target.value);
        });

        const taskNameInput = document.getElementById('taskNameFilter');
        if (taskNameInput) {
            taskNameInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    this.applyFilters();
                }
            });
        }

        // ç­›é€‰æŒ‰é’®
        document.getElementById('filterBtn').addEventListener('click', () => {
            this.applyFilters();
        });

        // é‡ç½®ç­›é€‰æŒ‰é’®
        document.getElementById('resetFilterBtn').addEventListener('click', () => {
            this.resetFilters();
        });
    },

    // åŠ è½½ä»»åŠ¡åˆ—è¡¨
    async loadTasks() {
        console.log('[Tasks] ä»»åŠ¡åˆ—è¡¨åŠ è½½å¼€å§‹');
        const tbody = document.getElementById('tasksTableBody');
        tbody.innerHTML = `
            <tr>
                <td colspan="8" style="padding: 0; border: none;">
                    <div class="loading-state">
                        <div class="loading-spinner"></div>
                        <div>åŠ è½½ä¸­...</div>
                    </div>
                </td>
            </tr>
        `;

        try {
            const result = await TasksAPI.getTaskList();
            if (result.success) {
                this.allTasks = result.data || [];
                this.sortAndRenderTasks();
            } else {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="padding: 0; border: none;">
                            <div class="empty-state">
                                <div class="empty-state-icon">âš ï¸</div>
                                <div class="empty-state-text">${result.message || 'åŠ è½½å¤±è´¥'}</div>
                            </div>
                        </td>
                    </tr>
                `;
            }
            console.log('[Tasks] ä»»åŠ¡åˆ—è¡¨åŠ è½½å®Œæˆ');
        } catch (error) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" style="padding: 0; border: none;">
                        <div class="empty-state">
                            <div class="empty-state-icon">âš ï¸</div>
                            <div class="empty-state-text">åŠ è½½ä»»åŠ¡æ—¶å‘ç”Ÿé”™è¯¯</div>
                        </div>
                    </td>
                </tr>
            `;
        }
    },


    // åº”ç”¨ç­›é€‰
    applyFilters() {
        this.filters.status = document.getElementById('statusFilter').value;
        this.filters.createdStart = document.getElementById('startDateFilter').value;
        this.filters.createdEnd = document.getElementById('endDateFilter').value;
        this.filters.keyword = document.getElementById('taskNameFilter').value.trim().toLowerCase();

        const hasFilters = Boolean(
            this.filters.status ||
            this.filters.createdStart ||
            this.filters.createdEnd ||
            this.filters.keyword
        );

        if (!hasFilters) {
            this.filteredTasks = [];
            this.sortAndRenderTasks();
            return;
        }

        this.filteredTasks = this.allTasks.filter(task => {
            if (this.filters.status && task.status !== this.filters.status) {
                return false;
            }

            const createdDate = task.created_at
                ? new Date(task.created_at).toISOString().split('T')[0]
                : '';

            if (this.filters.createdStart && (!createdDate || createdDate < this.filters.createdStart)) {
                return false;
            }

            if (this.filters.createdEnd && (!createdDate || createdDate > this.filters.createdEnd)) {
                return false;
            }

            if (this.filters.keyword) {
                const taskName = (task.name || '').toLowerCase();
                if (!taskName.includes(this.filters.keyword)) {
                    return false;
                }
            }

            return true;
        });

        this.sortAndRenderTasks();
    },

    // é‡ç½®ç­›é€‰
    resetFilters() {
        document.getElementById('statusFilter').value = '';
        document.getElementById('startDateFilter').value = '';
        document.getElementById('endDateFilter').value = '';
        document.getElementById('taskNameFilter').value = '';
        this.filters = {
            status: '',
            createdStart: '',
            createdEnd: '',
            keyword: ''
        };
        this.filteredTasks = [];
        this.sortAndRenderTasks();
    },

    // æ’åºå¹¶æ¸²æŸ“ä»»åŠ¡
    sortAndRenderTasks() {
        const hasFilters = Boolean(
            this.filters.status ||
            this.filters.createdStart ||
            this.filters.createdEnd ||
            this.filters.keyword
        );

        const tasksToSort = hasFilters ? this.filteredTasks : this.allTasks;

        const sorted = [...tasksToSort].sort((a, b) => {
            let aVal = a[this.sortBy];
            let bVal = b[this.sortBy];

            // å¤„ç†null/undefinedå€¼
            if (aVal == null) aVal = '';
            if (bVal == null) bVal = '';

            // å­—ç¬¦ä¸²æ¯”è¾ƒ
            if (typeof aVal === 'string') {
                const result = aVal.localeCompare(bVal);
                return this.sortOrder === 'asc' ? result : -result;
            }

            // æ•°å­—/æ—¥æœŸæ¯”è¾ƒ
            if (this.sortOrder === 'asc') {
                return aVal > bVal ? 1 : -1;
            } else {
                return aVal < bVal ? 1 : -1;
            }
        });

        this.renderTasks(sorted);
        this.updateSortUI();
    },

    // å¤„ç†æ’åºç‚¹å‡»
    handleSort(sortBy) {
        if (this.sortBy === sortBy) {
            this.sortOrder = this.sortOrder === 'asc' ? 'desc' : 'asc';
        } else {
            this.sortBy = sortBy;
            this.sortOrder = 'desc';
        }
        this.sortAndRenderTasks();
    },

    // æ›´æ–°æ’åºUI
    updateSortUI() {
        document.querySelectorAll('.sortable').forEach(th => {
            th.classList.remove('active');
            const icon = th.querySelector('.sort-icon');
            if (icon) icon.textContent = 'â‡…';
        });

        const activeTh = document.querySelector(`[data-sort="${this.sortBy}"]`);
        if (activeTh) {
            activeTh.classList.add('active');
            const icon = activeTh.querySelector('.sort-icon');
            if (icon) icon.textContent = this.sortOrder === 'asc' ? 'â–²' : 'â–¼';
        }
    },

    // æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨
    renderTasks(tasks) {
        const tbody = document.getElementById('tasksTableBody');
        
        if (tasks.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" style="padding: 0; border: none;">
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ“‹</div>
                            <div class="empty-state-text">æš‚æ— ä»»åŠ¡ï¼Œç‚¹å‡»å³ä¸Šè§’åˆ›å»ºæ–°ä»»åŠ¡</div>
                        </div>
                    </td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = tasks.map(task => {
            const statusClass = {
                'DRAFT': 'draft',
                'ACTIVE': 'active',
                'CLOSED': 'closed',
                'AGGREGATED': 'success',
                'NEEDS_REAGGREGATION': 'warning'
            }[task.status] || 'draft';

            let statusText = {
                'DRAFT': 'æœªå‘å¸ƒ',
                'ACTIVE': 'è¿›è¡Œä¸­',
                'CLOSED': 'å·²å…³é—­',
                'AGGREGATED': 'å·²æ±‡æ€»',
                'NEEDS_REAGGREGATION': 'éœ€é‡æ–°æ±‡æ€»'
            }[task.status] || task.status;

            // Add warning icon for NEEDS_REAGGREGATION
            if (task.status === 'NEEDS_REAGGREGATION') {
                statusText = `<span title="æ±‡æ€»åæœ‰æ–°é‚®ä»¶é€è¾¾ï¼Œå¯èƒ½éœ€é‡æ–°æ±‡æ€»">âš ï¸ ${statusText}</span>`;
            }

            return `
                <tr>
                    <td class="col-name"><a href="#" class="task-name-link" onclick="TasksPage.showDescription(${task.id}, '${task.name}'); return false;">${task.name}</a></td>
                    <td class="col-created">${task.created_at ? Utils.formatDateTime(task.created_at) : '-'}</td>
                    <td class="col-time">${task.started_time ? Utils.formatDateTime(task.started_time) : '-'}</td>
                    <td class="col-time">${task.deadline ? Utils.formatDateTime(task.deadline) : '-'}</td>
                    <td class="col-template">${task.template_name}</td>
                    <td class="col-count"><a href="#" class="task-count-link" onclick="TasksPage.showDetail(${task.id}); return false;">${task.replied_count}/${task.total_count}</a></td>
                    <td class="col-status"><span class="status-badge ${statusClass}">${statusText}</span></td>
                    <td class="col-actions">${this.renderActionButtons(task)}</td>
                </tr>
            `;
        }).join('');
    },

    // æ¸²æŸ“æ“ä½œæŒ‰é’®
    renderActionButtons(task) {
        const buttons = [];
        
        if (task.status === 'DRAFT') {
            buttons.push(`<button class="btn-primary btn-sm" onclick="TasksPage.publishTask(${task.id})">ä¸€é”®å‘å¸ƒ</button>`);
            buttons.push(`<button class="btn-secondary btn-sm" onclick="TasksPage.editTask(${task.id})">ç¼–è¾‘</button>`);
            buttons.push(`<button class="btn-danger btn-sm" onclick="TasksPage.deleteTask(${task.id})">åˆ é™¤</button>`);
        } else if (task.status === 'ACTIVE') {
            buttons.push(`<button class="btn-warning btn-sm" onclick="TasksPage.remindTeachers(${task.id})">ä¸€é”®å‚¬ä¿ƒ</button>`);
            buttons.push(`<button class="btn-danger btn-sm" onclick="TasksPage.closeTask(${task.id})">å…³é—­å¹¶å¯¼å‡º</button>`);
        } else if (task.status === 'CLOSED') {
            buttons.push(`<button class="btn-success btn-sm" onclick="TasksPage.exportData(${task.id})">ä¸€é”®å¯¼å‡º</button>`);
        } else if (task.status === 'AGGREGATED') {
            buttons.push(`<button class="btn-success btn-sm" onclick="TasksPage.exportData(${task.id})">é‡æ–°å¯¼å‡º</button>`);
        } else if (task.status === 'NEEDS_REAGGREGATION') {
            buttons.push(`<button class="btn-primary btn-sm" onclick="TasksPage.exportData(${task.id})">é‡æ–°å¯¼å‡º</button>`);
        }

        return `<div class="action-buttons">${buttons.join('')}</div>`;
    },

    // æ˜¾ç¤ºä»»åŠ¡æè¿°
    async showDescription(taskId, taskName) {
        const result = await TasksAPI.getTaskDetail(taskId);
        if (result.success) {
            document.getElementById('taskDescTitle').textContent = taskName;
            document.getElementById('taskDescContent').textContent = result.data.description || 'æ— æè¿°';
            document.getElementById('taskDescModal').style.display = 'flex';
        } else {
            alert(result.message);
        }
    },

    closeDescModal() {
        document.getElementById('taskDescModal').style.display = 'none';
    },

    // æ˜¾ç¤ºä»»åŠ¡è¯¦æƒ…
    async showDetail(taskId) {
        const result = await TasksAPI.getTaskDetail(taskId);
        if (result.success) {
            this.renderTaskDetail(result.data);
            document.getElementById('taskDetailModal').style.display = 'flex';
        } else {
            alert(result.message);
        }
    },

    renderTaskDetail(task) {
        const tbody = document.getElementById('taskDetailTableBody');
        tbody.innerHTML = task.teachers.map(teacher => `
            <tr>
                <td>${teacher.name}</td>
                <td>${teacher.id}</td>
                <td>${teacher.email}</td>
                <td><span class="reply-status ${teacher.has_replied ? 'replied' : 'not-replied'}">${teacher.has_replied ? 'å·²å›å¤' : 'æœªå›å¤'}</span></td>
            </tr>
        `).join('');
    },

    closeDetailModal() {
        document.getElementById('taskDetailModal').style.display = 'none';
    },

    // æ‰“å¼€æ–°å»ºä»»åŠ¡å¼¹çª—
    openCreateModal() {
        this.isEditMode = false;
        this.editTaskId = null;
        this.currentStep = 1;
        this.selectedTeacherIds.clear(); // æ¸…ç©ºé€‰ä¸­çŠ¶æ€
        document.getElementById('taskFormTitle').textContent = 'æ–°å»ºä»»åŠ¡';
        document.getElementById('stepProgress').style.display = 'flex';
        document.getElementById('taskForm').reset();
        this.updateStepUI();
        // ä¸åœ¨è¿™é‡Œæ¸²æŸ“æ•™å¸ˆåˆ—è¡¨ï¼Œç­‰åˆ°step3æ˜¾ç¤ºæ—¶å†æ¸²æŸ“
        document.getElementById('taskFormModal').style.display = 'flex';
    },

    // ç¼–è¾‘ä»»åŠ¡
    async editTask(taskId) {
        const result = await TasksAPI.getTaskDetail(taskId);
        if (!result.success) {
            alert(result.message);
            return;
        }

        const task = result.data;
        this.isEditMode = true;
        this.editTaskId = taskId;
        this.currentStep = 1;

        document.getElementById('taskFormTitle').textContent = 'ç¼–è¾‘ä»»åŠ¡';
        document.getElementById('stepProgress').style.display = 'none';

        // å¡«å……è¡¨å•
        document.getElementById('taskName').value = task.name;
        document.getElementById('taskDesc').value = task.description || '';
        document.getElementById('taskDeadline').value = task.deadline ? new Date(task.deadline).toISOString().slice(0, 16) : '';
        document.getElementById('taskTemplate').value = task.template_id;
        document.getElementById('mailSubject').value = task.mail_subject || '';
        document.getElementById('mailContent').value = task.mail_content || '';

        if (task.started_time) {
            document.querySelector('input[name="publishType"][value="scheduled"]').checked = true;
            document.getElementById('taskStartTime').style.display = 'block';
            document.getElementById('taskStartTime').value = new Date(task.started_time).toISOString().slice(0, 16);
        }

        // æ˜¾ç¤ºæ‰€æœ‰æ­¥éª¤
        document.querySelectorAll('.form-section').forEach(section => section.classList.add('active'));
        
        // é¢„é€‰æ•™å¸ˆï¼ˆä½¿ç”¨selectedTeacherIdsï¼‰
        this.selectedTeacherIds.clear();
        task.teachers.forEach(t => this.selectedTeacherIds.add(t.id));
        this.renderTeacherList();

        document.getElementById('btnNext').style.display = 'none';
        document.getElementById('btnPrev').style.display = 'none';
        document.getElementById('btnSubmit').style.display = 'inline-block';
        document.getElementById('btnSubmit').textContent = 'ä¿å­˜';

        document.getElementById('taskFormModal').style.display = 'flex';
    },

    // å…³é—­è¡¨å•å¼¹çª—
    closeFormModal() {
        document.getElementById('taskFormModal').style.display = 'none';
        document.getElementById('taskForm').reset();
        this.currentStep = 1;
        this.updateStepUI();
    },

    // ä¸‹ä¸€æ­¥
    nextStep() {
        if (!this.validateStep(this.currentStep)) {
            return;
        }
        
        if (this.currentStep < 3) {
            this.currentStep++;
            this.updateStepUI();
        }
    },

    // ä¸Šä¸€æ­¥
    prevStep() {
        if (this.currentStep > 1) {
            this.currentStep--;
            this.updateStepUI();
        }
    },

    // æ›´æ–°æ­¥éª¤UI
    updateStepUI() {
        // æ›´æ–°è¿›åº¦æ¡
        document.querySelectorAll('.step-item').forEach((item, index) => {
            item.classList.remove('active', 'completed');
            if (index + 1 < this.currentStep) {
                item.classList.add('completed');
            } else if (index + 1 === this.currentStep) {
                item.classList.add('active');
            }
        });

        // æ›´æ–°è¡¨å•åŒºåŸŸæ˜¾ç¤º
        document.querySelectorAll('.form-section').forEach((section, index) => {
            section.classList.toggle('active', index + 1 === this.currentStep);
        });

        // æ›´æ–°æŒ‰é’®æ˜¾ç¤º
        document.getElementById('btnPrev').style.display = this.currentStep > 1 ? 'inline-block' : 'none';
        document.getElementById('btnNext').style.display = this.currentStep < 3 ? 'inline-block' : 'none';
        document.getElementById('btnSubmit').style.display = this.currentStep === 3 ? 'inline-block' : 'none';
        
        // å½“åˆ‡æ¢åˆ°step3æ—¶ï¼Œæ¸²æŸ“æ•™å¸ˆåˆ—è¡¨
        if (this.currentStep === 3) {
            this.renderTeacherList();
        }
    },

    // éªŒè¯å½“å‰æ­¥éª¤
    validateStep(step) {
        if (step === 1) {
            const name = document.getElementById('taskName').value.trim();
            const deadline = document.getElementById('taskDeadline').value;
            const publishType = document.querySelector('input[name="publishType"]:checked').value;
            const startTime = document.getElementById('taskStartTime').value;

            if (!name) {
                alert('è¯·å¡«å†™ä»»åŠ¡åç§°');
                return false;
            }
            if (!deadline) {
                alert('è¯·é€‰æ‹©æˆªæ­¢æ—¶é—´');
                return false;
            }
            if (publishType === 'scheduled' && !startTime) {
                alert('è¯·é€‰æ‹©å‘å¸ƒæ—¶é—´');
                return false;
            }
            return true;
        } else if (step === 2) {
            const template = document.getElementById('taskTemplate').value;
            const subject = document.getElementById('mailSubject').value.trim();
            const content = document.getElementById('mailContent').value.trim();

            if (!template) {
                alert('è¯·é€‰æ‹©è¡¨æ ¼æ¨¡æ¿');
                return false;
            }
            if (!subject) {
                alert('è¯·å¡«å†™é‚®ä»¶æ ‡é¢˜');
                return false;
            }
            if (!content) {
                alert('è¯·å¡«å†™é‚®ä»¶æ­£æ–‡');
                return false;
            }
            return true;
        } else if (step === 3) {
            if (this.selectedTeacherIds.size === 0) {
                alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä½æ•™å¸ˆ');
                return false;
            }
            return true;
        }
        return true;
    },

    // æäº¤ä»»åŠ¡
    async submitTask() {
        if (!this.validateStep(1) || !this.validateStep(2) || !this.validateStep(3)) {
            return;
        }

        const publishType = document.querySelector('input[name="publishType"]:checked').value;
        const teacherIds = Array.from(this.selectedTeacherIds);

        const taskData = {
            name: document.getElementById('taskName').value.trim(),
            description: document.getElementById('taskDesc').value.trim() || null,
            deadline: new Date(document.getElementById('taskDeadline').value).toISOString(),
            started_time: publishType === 'scheduled' ? new Date(document.getElementById('taskStartTime').value).toISOString() : null,
            template_id: parseInt(document.getElementById('taskTemplate').value),
            mail_subject: document.getElementById('mailSubject').value.trim(),
            mail_content: document.getElementById('mailContent').value.trim(),
            teacher_ids: teacherIds
        };

        const result = this.isEditMode 
            ? await TasksAPI.updateTask(this.editTaskId, taskData)
            : await TasksAPI.createTask(taskData);

        if (result.success) {
            alert(result.message);
            this.closeFormModal();
            this.loadTasks();
        } else {
            alert(result.message);
        }
    },

    // åŠ è½½æ¨¡æ¿åˆ—è¡¨
    async loadTemplates() {
        const result = await TasksAPI.getTemplates();
        if (result.success) {
            this.allTemplates = result.data || [];
            const select = document.getElementById('taskTemplate');
            select.innerHTML = '<option value="">è¯·é€‰æ‹©æ¨¡æ¿</option>' + 
                this.allTemplates.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
        }
    },

    // åŠ è½½æ•™å¸ˆåˆ—è¡¨
    async loadTeachers() {
        try {
            const result = await TasksAPI.getTeachers();
            if (result.success) {
                this.allTeachers = result.data || [];
            } else {
                this.allTeachers = [];
            }
        } catch (error) {
            this.allTeachers = [];
        }
    },

    // æ¸²æŸ“æ•™å¸ˆåˆ—è¡¨
    renderTeacherList(filter = '') {
        const tbody = document.getElementById('teacherListBody');
        if (!tbody) return;
        
        // ç­›é€‰æ•™å¸ˆï¼ˆç­›é€‰ä¸å½±å“é€‰ä¸­çŠ¶æ€ï¼‰
        const filterLower = filter.toLowerCase();
        const teachers = filter 
            ? this.allTeachers.filter(t => 
                t.name.toLowerCase().includes(filterLower) || 
                t.email.toLowerCase().includes(filterLower) || 
                String(t.id).includes(filter)
              )
            : this.allTeachers;
        
        if (teachers.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 20px; color: #9CA3AF;">æš‚æ— æ•™å¸ˆæ•°æ®</td></tr>';
            return;
        }

        // æ ¹æ®selectedTeacherIdsæ¸²æŸ“ï¼Œç¡®ä¿é€‰ä¸­çŠ¶æ€ä¸å—ç­›é€‰å½±å“
        tbody.innerHTML = teachers.map(teacher => {
            const isSelected = this.selectedTeacherIds.has(teacher.id);
            return `
                <tr class="teacher-row ${isSelected ? 'selected' : ''}" data-teacher-id="${teacher.id}" onclick="TasksPage.toggleTeacherRow(${teacher.id})">
                    <td>${teacher.name}</td>
                    <td>${teacher.id}</td>
                    <td>${teacher.email}</td>
                </tr>
            `;
        }).join('');
        
        // æ›´æ–°é€‰ä¸­æ•°é‡å’Œå…¨é€‰æŒ‰é’®çŠ¶æ€
        this.updateSelectedCount();
        this.updateSelectAllState();
    },

    // è¿‡æ»¤æ•™å¸ˆ
    filterTeachers(keyword) {
        this.renderTeacherList(keyword);
    },

    // åˆ‡æ¢æ•™å¸ˆè¡Œé€‰ä¸­çŠ¶æ€
    toggleTeacherRow(teacherId) {
        const row = document.querySelector(`tr[data-teacher-id="${teacherId}"]`);
        if (!row) return;
        
        // åˆ‡æ¢é€‰ä¸­çŠ¶æ€
        if (this.selectedTeacherIds.has(teacherId)) {
            this.selectedTeacherIds.delete(teacherId);
            row.classList.remove('selected');
        } else {
            this.selectedTeacherIds.add(teacherId);
            row.classList.add('selected');
        }
        
        this.updateSelectedCount();
        this.updateSelectAllState();
    },

    // å…¨é€‰/å–æ¶ˆå…¨é€‰
    toggleSelectAll(selectAll) {
        if (selectAll) {
            // å…¨é€‰ï¼šå°†æ‰€æœ‰æ•™å¸ˆIDåŠ å…¥selectedTeacherIds
            this.allTeachers.forEach(teacher => {
                this.selectedTeacherIds.add(teacher.id);
            });
        } else {
            // å–æ¶ˆå…¨é€‰ï¼šæ¸…ç©ºselectedTeacherIds
            this.selectedTeacherIds.clear();
        }
        
        // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°UI
        this.renderTeacherList(document.getElementById('teacherSearch').value);
    },

    // æ›´æ–°å…¨é€‰æŒ‰é’®çŠ¶æ€
    updateSelectAllState() {
        const selectAllCheckbox = document.getElementById('selectAllTeachers');
        if (this.allTeachers.length === 0) {
            selectAllCheckbox.checked = false;
        } else {
            selectAllCheckbox.checked = this.selectedTeacherIds.size === this.allTeachers.length;
        }
    },

    // æ›´æ–°é€‰ä¸­æ•°é‡
    updateSelectedCount() {
        const count = this.selectedTeacherIds.size;
        document.getElementById('selectedCount').textContent = `å·²é€‰æ‹©: ${count}`;
    },

    // ä¸€é”®å‘å¸ƒä»»åŠ¡
    async publishTask(taskId) {
        if (!confirm('ç¡®å®šè¦ç«‹å³å‘å¸ƒè¿™ä¸ªä»»åŠ¡å—ï¼Ÿå‘å¸ƒåå°†ç«‹å³å‘é€é‚®ä»¶ç»™æ‰€æœ‰ç›®æ ‡æ•™å¸ˆã€‚')) {
            return;
        }

        const result = await TasksAPI.publishTask(taskId);
        if (result.success) {
            alert(result.message);
            this.loadTasks();
        } else {
            alert(result.message);
        }
    },

    // å…³é—­ä»»åŠ¡
    async closeTask(taskId) {
        if (!confirm('ç¡®å®šè¦å…³é—­è¿™ä¸ªä»»åŠ¡å—ï¼Ÿ')) {
            return;
        }

        const result = await TasksAPI.closeTask(taskId);
        if (result.success) {
            alert(result.message);
            this.loadTasks();
        } else {
            alert(result.message);
        }
    },

    // å‚¬ä¿ƒæ•™å¸ˆ
    async remindTeachers(taskId) {
        if (!confirm('ç¡®å®šè¦å‘æ‰€æœ‰å°šæœªå›å¤çš„æ•™å¸ˆå‘é€å‚¬ä¿ƒé‚®ä»¶å—ï¼Ÿ')) {
            return;
        }
        
        const btn = document.querySelector(`button[onclick="TasksPage.remindTeachers(${taskId})"]`);
        const originalText = btn ? btn.textContent : 'ä¸€é”®å‚¬ä¿ƒ';
        if (btn) {
            btn.textContent = 'å‘é€ä¸­...';
            btn.disabled = true;
        }

        try {
            const result = await TasksAPI.remindTask(taskId);
            if (result.success) {
                alert(result.message);
            } else {
                alert(result.message);
            }
        } catch (error) {
            alert('å‚¬ä¿ƒå¤±è´¥ï¼Œè¯·é‡è¯•');
        } finally {
            if (btn) {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }
    },

    // å¯¼å‡ºæ•°æ®
    async exportData(taskId) {
        if (!confirm('ç¡®å®šè¦åˆå¹¶å¹¶å¯¼å‡ºå½“å‰ä»»åŠ¡çš„æ•°æ®å—ï¼Ÿè¿™å¯èƒ½éœ€è¦ä¸€ç‚¹æ—¶é—´ã€‚')) {
            return;
        }

        const btn = document.querySelector(`button[onclick="TasksPage.exportData(${taskId})"]`);
        const originalText = btn ? btn.textContent : 'åˆå¹¶å¹¶å¯¼å‡º';
        if (btn) {
            btn.textContent = 'å¤„ç†ä¸­...';
            btn.disabled = true;
        }

        try {
            const result = await TasksAPI.aggregateTask(taskId);
            if (result.success) {
                alert('åˆå¹¶æˆåŠŸï¼æ–‡ä»¶å·²ç”Ÿæˆã€‚');
            } else {
                alert(result.message);
            }
        } catch (error) {
            alert('å¯¼å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•');
        } finally {
            if (btn) {
                btn.textContent = originalText;
                btn.disabled = false;
            }
            this.loadTasks(); // Reload to update status
        }
    },

    // åˆ é™¤ä»»åŠ¡
    async deleteTask(taskId) {
        if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä»»åŠ¡å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
            return;
        }

        const result = await TasksAPI.deleteTask(taskId);
        if (result.success) {
            alert(result.message);
            this.loadTasks();
        } else {
            alert(result.message);
        }
    }
};

// æš´éœ²åˆ°å…¨å±€ä¾›HTML onclickä½¿ç”¨
window.TasksPage = TasksPage;

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
setTimeout(() => {
    const tbody = document.getElementById('tasksTableBody');
    if (tbody) {
        TasksPage.init();
    } else {
        setTimeout(() => TasksPage.init(), 100);
    }
}, 0);

})(); // ç«‹å³æ‰§è¡Œå‡½æ•°ç»“æŸ
</script>