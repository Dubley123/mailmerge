<!-- å·²æ±‡æ€»è¡¨å•é¡µé¢ -->
<link rel="stylesheet" href="/frontend/static/css/aggregations.css">

<div class="aggregations-container">
    <!-- é¡¶éƒ¨å·¥å…·æ  -->
    <div class="toolbar">
        <div class="toolbar-left">
            <h1 class="page-title">å·²æ±‡æ€»è¡¨å•</h1>
        </div>
        <div class="toolbar-right">
            <!-- ç­›é€‰æ§ä»¶ -->
            <div class="filter-group">
                <select id="taskFilter" class="filter-select">
                    <option value="">å…¨éƒ¨ä»»åŠ¡</option>
                </select>
                <input type="date" id="startDateFilter" class="filter-input" placeholder="èµ·å§‹æ—¶é—´">
                <input type="date" id="endDateFilter" class="filter-input" placeholder="ç»ˆæ­¢æ—¶é—´">
                <button id="filterBtn" class="btn-secondary">ç­›é€‰</button>
                <button id="resetFilterBtn" class="btn-secondary">é‡ç½®</button>
            </div>
            <button id="refreshBtn" class="btn-primary">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>
                    <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
                </svg>
                åˆ·æ–°
            </button>
        </div>
    </div>

    <!-- åŠ è½½æŒ‡ç¤ºå™¨ -->
    <div id="loadingIndicator" class="loading-indicator" style="display: none;">
        <div class="loading-spinner"></div>
        <div>åŠ è½½ä¸­...</div>
    </div>

    <!-- é”™è¯¯æç¤º -->
    <div id="errorMessage" class="error-message" style="display: none;"></div>

    <!-- æ±‡æ€»è¡¨è¡¨æ ¼ -->
    <div class="table-card">
        <table class="aggregations-table">
            <thead>
                <tr>
                    <th class="col-name sortable" data-sort="name">
                        æ±‡æ€»è¡¨åç§°
                        <span class="sort-icon">â‡…</span>
                    </th>
                    <th class="col-task sortable" data-sort="task_name">
                        å¯¹åº”ä»»åŠ¡
                        <span class="sort-icon">â‡…</span>
                    </th>
                    <th class="col-time sortable active" data-sort="generated_at">
                        æ±‡æ€»æ—¶é—´
                        <span class="sort-icon">â–¼</span>
                    </th>
                    <th class="col-count">è®°å½•æ•°é‡</th>
                    <th class="col-actions">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="aggregationsTableBody">
                <!-- æ•°æ®è¡Œå°†ç”± JS åŠ¨æ€ç”Ÿæˆ -->
            </tbody>
        </table>

        <!-- ç©ºçŠ¶æ€ -->
        <div id="emptyState" class="empty-state" style="display: none;">
            <div class="empty-state-icon">ğŸ“¦</div>
            <div class="empty-state-text">æš‚æ— æ±‡æ€»è¡¨</div>
        </div>
    </div>

    <!-- åˆ†é¡µæ§ä»¶ -->
    <div class="pagination" id="pagination" style="display: none;">
        <button id="prevPageBtn" class="pagination-btn" disabled>ä¸Šä¸€é¡µ</button>
        <span id="pageInfo" class="page-info">ç¬¬ 1 é¡µ / å…± 1 é¡µ</span>
        <button id="nextPageBtn" class="pagination-btn" disabled>ä¸‹ä¸€é¡µ</button>
        <div class="page-size-selector">
            æ¯é¡µæ˜¾ç¤º
            <select id="pageSizeSelect">
                <option value="10">10</option>
                <option value="20" selected>20</option>
                <option value="50">50</option>
            </select>
            æ¡
        </div>
    </div>
</div>

<script>
(function() {
    console.log('[Aggregations] é¡µé¢è„šæœ¬å¼€å§‹æ‰§è¡Œ');

    // ==================== çŠ¶æ€ç®¡ç† ====================
    const state = {
        currentPage: 1,
        pageSize: 20,
        total: 0,
        sortBy: 'generated_at',
        sortOrder: 'desc',
        filters: {
            taskId: null,
            startDate: null,
            endDate: null
        },
        tasks: [] // ä»»åŠ¡åˆ—è¡¨ï¼ˆç”¨äºç­›é€‰ä¸‹æ‹‰æ¡†ï¼‰
    };

    // ==================== DOM å…ƒç´  ====================
    const elements = {
        loadingIndicator: document.getElementById('loadingIndicator'),
        errorMessage: document.getElementById('errorMessage'),
        tableBody: document.getElementById('aggregationsTableBody'),
        emptyState: document.getElementById('emptyState'),
        pagination: document.getElementById('pagination'),
        pageInfo: document.getElementById('pageInfo'),
        prevPageBtn: document.getElementById('prevPageBtn'),
        nextPageBtn: document.getElementById('nextPageBtn'),
        pageSizeSelect: document.getElementById('pageSizeSelect'),
        refreshBtn: document.getElementById('refreshBtn'),
        taskFilter: document.getElementById('taskFilter'),
        startDateFilter: document.getElementById('startDateFilter'),
        endDateFilter: document.getElementById('endDateFilter'),
        filterBtn: document.getElementById('filterBtn'),
        resetFilterBtn: document.getElementById('resetFilterBtn')
    };

    // ==================== å·¥å…·å‡½æ•° ====================
    function showLoading() {
        elements.loadingIndicator.style.display = 'flex';
        elements.errorMessage.style.display = 'none';
    }

    function hideLoading() {
        elements.loadingIndicator.style.display = 'none';
    }

    function showError(message) {
        elements.errorMessage.textContent = message;
        elements.errorMessage.style.display = 'block';
        hideLoading();
    }

    function formatDateTime(dateStr) {
        const date = new Date(dateStr);
        return date.toLocaleString('zh-CN', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    // ==================== API è°ƒç”¨ ====================
    async function fetchAggregations() {
        showLoading();
        try {
            const params = new URLSearchParams({
                page: state.currentPage,
                page_size: state.pageSize,
                sort_by: state.sortBy,
                sort_order: state.sortOrder
            });

            if (state.filters.taskId) {
                params.append('task_id', state.filters.taskId);
            }
            if (state.filters.startDate) {
                params.append('start_date', state.filters.startDate);
            }
            if (state.filters.endDate) {
                params.append('end_date', state.filters.endDate);
            }

            const result = await CommonAPI.get(`/api/aggregations/list?${params.toString()}`);
            hideLoading();

            if (result.success) {
                // CommonAPIåŒ…è£…å: result.data = {data: [...], total: 10}
                state.total = result.data.total;
                renderTable(result.data.data);
                updatePagination();
            } else {
                showError(result.error || 'è·å–æ±‡æ€»è¡¨åˆ—è¡¨å¤±è´¥');
            }
        } catch (error) {
            console.error('[Aggregations] è·å–åˆ—è¡¨å¤±è´¥:', error);
            showError('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
        }
    }

    async function fetchTasks() {
        try {
            const result = await CommonAPI.get('/api/tasks/list');
            if (result.success) {
                state.tasks = result.data;
                renderTaskFilter();
            }
        } catch (error) {
            console.error('[Aggregations] è·å–ä»»åŠ¡åˆ—è¡¨å¤±è´¥:', error);
        }
    }

    async function downloadAggregation(aggregationId, filename) {
        try {
            // ä½¿ç”¨ fetch å¸¦è®¤è¯ä¿¡æ¯ä¸‹è½½æ–‡ä»¶
            const token = localStorage.getItem('mailmerge_token');
            if (!token) {
                alert('è¯·å…ˆç™»å½•');
                return;
            }

            const response = await fetch(`/api/aggregations/${aggregationId}/download`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (!response.ok) {
                if (response.status === 401) {
                    alert('è®¤è¯å¤±è´¥ï¼Œè¯·é‡æ–°ç™»å½•');
                    return;
                }
                throw new Error('ä¸‹è½½å¤±è´¥');
            }

            // è·å–æ–‡ä»¶åï¼ˆä»å“åº”å¤´ï¼‰
            const contentDisposition = response.headers.get('content-disposition');
            let downloadFilename = 'aggregation.xlsx';
            
            if (contentDisposition) {
                // æ”¯æŒ RFC 5987 ç¼–ç çš„æ–‡ä»¶å (filename*=UTF-8''...)
                const filenameStarMatch = /filename\*=UTF-8''(.+)/.exec(contentDisposition);
                if (filenameStarMatch) {
                    downloadFilename = decodeURIComponent(filenameStarMatch[1]);
                } else {
                    // ä¼ ç»Ÿæ ¼å¼ (filename="...")
                    const filenameMatch = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/.exec(contentDisposition);
                    if (filenameMatch && filenameMatch[1]) {
                        downloadFilename = filenameMatch[1].replace(/['"]/g, '');
                    }
                }
            }

            // åˆ›å»º Blob å¹¶ä¸‹è½½
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = downloadFilename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        } catch (error) {
            console.error('[Aggregations] ä¸‹è½½å¤±è´¥:', error);
            alert('ä¸‹è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
        }
    }

    // ==================== æ¸²æŸ“å‡½æ•° ====================
    function renderTaskFilter() {
        const options = state.tasks.map(task => 
            `<option value="${task.id}">${task.name}</option>`
        ).join('');
        elements.taskFilter.innerHTML = `<option value="">å…¨éƒ¨ä»»åŠ¡</option>${options}`;
    }

    function renderTable(aggregations) {
        if (aggregations.length === 0) {
            elements.tableBody.innerHTML = '';
            elements.emptyState.style.display = 'flex';
            elements.pagination.style.display = 'none';
            return;
        }

        elements.emptyState.style.display = 'none';
        
        const rows = aggregations.map(agg => `
            <tr>
                <td class="col-name">${escapeHtml(agg.name)}</td>
                <td class="col-task">${escapeHtml(agg.task_name)}</td>
                <td class="col-time">${formatDateTime(agg.generated_at)}</td>
                <td class="col-count">${agg.record_count || '-'}</td>
                <td class="col-actions">
                    <button class="btn-download" onclick="window.aggregationsPage.handleDownload(${agg.id}, '${escapeHtml(agg.name)}')">
                        <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                            <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
                        </svg>
                        ä¸‹è½½
                    </button>
                </td>
            </tr>
        `).join('');

        elements.tableBody.innerHTML = rows;
    }

    function updatePagination() {
        const totalPages = Math.ceil(state.total / state.pageSize);
        
        if (totalPages <= 1) {
            elements.pagination.style.display = 'none';
            return;
        }

        elements.pagination.style.display = 'flex';
        elements.pageInfo.textContent = `ç¬¬ ${state.currentPage} é¡µ / å…± ${totalPages} é¡µ (å…± ${state.total} æ¡)`;
        elements.prevPageBtn.disabled = state.currentPage === 1;
        elements.nextPageBtn.disabled = state.currentPage === totalPages;
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // ==================== äº‹ä»¶å¤„ç† ====================
    function handleDownload(aggregationId, filename) {
        downloadAggregation(aggregationId, filename);
    }

    function handleSort(sortBy) {
        if (state.sortBy === sortBy) {
            state.sortOrder = state.sortOrder === 'asc' ? 'desc' : 'asc';
        } else {
            state.sortBy = sortBy;
            state.sortOrder = 'desc';
        }
        state.currentPage = 1;
        updateSortUI();
        fetchAggregations();
    }

    function updateSortUI() {
        document.querySelectorAll('.sortable').forEach(th => {
            th.classList.remove('active');
            th.querySelector('.sort-icon').textContent = 'â‡…';
        });

        const activeTh = document.querySelector(`[data-sort="${state.sortBy}"]`);
        if (activeTh) {
            activeTh.classList.add('active');
            activeTh.querySelector('.sort-icon').textContent = state.sortOrder === 'asc' ? 'â–²' : 'â–¼';
        }
    }

    function handleFilter() {
        state.filters.taskId = elements.taskFilter.value || null;
        state.filters.startDate = elements.startDateFilter.value || null;
        state.filters.endDate = elements.endDateFilter.value || null;
        state.currentPage = 1;
        fetchAggregations();
    }

    function handleResetFilter() {
        elements.taskFilter.value = '';
        elements.startDateFilter.value = '';
        elements.endDateFilter.value = '';
        state.filters = {
            taskId: null,
            startDate: null,
            endDate: null
        };
        state.currentPage = 1;
        fetchAggregations();
    }

    // ==================== äº‹ä»¶ç»‘å®š ====================
    elements.refreshBtn.addEventListener('click', () => fetchAggregations());
    elements.filterBtn.addEventListener('click', handleFilter);
    elements.resetFilterBtn.addEventListener('click', handleResetFilter);
    elements.prevPageBtn.addEventListener('click', () => {
        if (state.currentPage > 1) {
            state.currentPage--;
            fetchAggregations();
        }
    });
    elements.nextPageBtn.addEventListener('click', () => {
        const totalPages = Math.ceil(state.total / state.pageSize);
        if (state.currentPage < totalPages) {
            state.currentPage++;
            fetchAggregations();
        }
    });
    elements.pageSizeSelect.addEventListener('change', (e) => {
        state.pageSize = parseInt(e.target.value);
        state.currentPage = 1;
        fetchAggregations();
    });

    // æ’åºç‚¹å‡»äº‹ä»¶
    document.querySelectorAll('.sortable').forEach(th => {
        th.addEventListener('click', () => {
            const sortBy = th.dataset.sort;
            handleSort(sortBy);
        });
    });

    // è®¾ç½®date inputçš„ä¸­æ–‡placeholder
    setupDateInputs();

    // ==================== Date Input è®¾ç½® ====================
    function setupDateInputs() {
        const startDateInput = elements.startDateFilter;
        const endDateInput = elements.endDateFilter;
        
        // è®¾ç½®ä¸­æ–‡placeholder
        if (startDateInput && !startDateInput.value) {
            startDateInput.setAttribute('data-placeholder', 'èµ·å§‹æ—¶é—´ï¼ˆå¹´-æœˆ-æ—¥ï¼‰');
        }
        if (endDateInput && !endDateInput.value) {
            endDateInput.setAttribute('data-placeholder', 'ç»ˆæ­¢æ—¶é—´ï¼ˆå¹´-æœˆ-æ—¥ï¼‰');
        }
        
        // ç›‘å¬å˜åŒ–ä»¥æ›´æ–°æ˜¾ç¤ºæ ¼å¼
        [startDateInput, endDateInput].forEach(input => {
            if (input) {
                input.addEventListener('change', function() {
                    if (this.value) {
                        // å°†YYYY-MM-DDè½¬æ¢ä¸ºYYYYå¹´MMæœˆDDæ—¥æ˜¾ç¤º
                        const date = new Date(this.value);
                        const year = date.getFullYear();
                        const month = String(date.getMonth() + 1).padStart(2, '0');
                        const day = String(date.getDate()).padStart(2, '0');
                        this.setAttribute('data-value', `${year}å¹´${month}æœˆ${day}æ—¥`);
                    }
                });
            }
        });
    }

    // ==================== å¯¼å‡ºå…¨å±€å‡½æ•° ====================
    window.aggregationsPage = {
        handleDownload: handleDownload
    };

    // ==================== åˆå§‹åŒ– ====================
    (async function init() {
        console.log('[Aggregations] åˆå§‹åŒ–å¼€å§‹');
        
        // ç­‰å¾… CommonAPI åŠ è½½
        if (typeof CommonAPI === 'undefined') {
            await new Promise(resolve => setTimeout(resolve, 300));
        }

        // åŠ è½½ä»»åŠ¡åˆ—è¡¨ï¼ˆç”¨äºç­›é€‰ï¼‰
        await fetchTasks();

        // åŠ è½½æ±‡æ€»è¡¨åˆ—è¡¨
        await fetchAggregations();

        console.log('[Aggregations] åˆå§‹åŒ–å®Œæˆ');
    })();
})();
</script>
