<!-- å·²æ±‡æ€»è¡¨å•é¡µé¢ -->
<link rel="stylesheet" href="/frontend/static/css/aggregations.css?v=3ee53c8a">

<div class="aggregations-container">
    <!-- é¡¶éƒ¨å·¥å…·æ  -->
    <h1 class="page-title">å·²æ±‡æ€»è¡¨å•</h1>
    <div class="toolbar">
        <div class="toolbar-left">
            <!-- ç­›é€‰æ§ä»¶ -->
            <div class="filter-group">
                <span style="font-size: 14px; color: #374151; margin-left: 8px;">æ±‡æ€»æ—¶é—´èŒƒå›´</span>
                <input type="date" id="startDateFilter" class="filter-input" placeholder="èµ·å§‹æ—¶é—´">
                <span style="color: #9CA3AF;">â€”</span>
                <input type="date" id="endDateFilter" class="filter-input" placeholder="ç»ˆæ­¢æ—¶é—´">
                <input type="text" id="taskNameFilter" class="filter-input" placeholder="è¾“å…¥ä»»åŠ¡åç§°">
                <button id="filterBtn" class="btn-secondary">ç­›é€‰</button>
                <button id="resetFilterBtn" class="btn-secondary">é‡ç½®</button>
            </div>
        </div>
        <div class="toolbar-right">
            <button id="refreshBtn" class="btn-primary">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>
                    <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
                </svg>
                åˆ·æ–°
            </button>
        </div>
    </div>

    <!-- åŠ è½½æŒ‡ç¤ºå™¨ -->
    <!-- <div id="loadingIndicator" class="loading-indicator" style="display: none;">
        <div class="loading-spinner"></div>
        <div>åŠ è½½ä¸­...</div>
    </div> -->

    <!-- é”™è¯¯æç¤º -->
    <div id="errorMessage" class="error-message" style="display: none;"></div>

    <!-- æ±‡æ€»è¡¨è¡¨æ ¼ -->
    <div class="table-card">
        <table class="aggregations-table">
            <thead>
                <tr>
                    <th class="col-name sortable" data-sort="name">
                        æ±‡æ€»è¡¨åç§°
                        <span class="sort-icon">â‡…</span>
                    </th>
                    <th class="col-task sortable" data-sort="task_name">
                        å¯¹åº”ä»»åŠ¡
                        <span class="sort-icon">â‡…</span>
                    </th>
                    <th class="col-time sortable active" data-sort="generated_at">
                        æ±‡æ€»æ—¶é—´
                        <span class="sort-icon">â–¼</span>
                    </th>
                    <th class="col-count">è®°å½•æ•°é‡</th>
                            <th class="col-validate">æ ¡éªŒçŠ¶æ€</th>
                    <th class="col-actions">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="aggregationsTableBody">
                <!-- æ•°æ®è¡Œå°†ç”± JS åŠ¨æ€ç”Ÿæˆ -->
            </tbody>
        </table>

        <!-- ç©ºçŠ¶æ€ -->
        <div id="emptyState" class="empty-state" style="display: none;">
            <div class="empty-state-icon">ğŸ“¦</div>
            <div class="empty-state-text">æš‚æ— æ±‡æ€»è¡¨</div>
        </div>
    </div>
    <!-- æ ¡éªŒé”™è¯¯è¯¦æƒ…å¼¹çª— -->
    <div id="validationErrorsModal" class="modal-overlay" style="display:none;">
        <div class="modal modal-detail" style="max-width: 800px; width: 90%;">
            <div class="modal-header">
                <h2 class="modal-title">æ ¡éªŒé”™è¯¯è¯¦æƒ…</h2>
                <button class="modal-close" onclick="window.aggregationsPage.closeValidationModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="validationErrorsContent">
                    <table class="validation-table" style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background-color: #f3f4f6; text-align: left;">
                                <th style="padding: 10px; border-bottom: 1px solid #e5e7eb;">æ•™å¸ˆ</th>
                                <th style="padding: 10px; border-bottom: 1px solid #e5e7eb;">å­—æ®µåç§°</th>
                                <th style="padding: 10px; border-bottom: 1px solid #e5e7eb;">é”™è¯¯ç±»å‹</th>
                                <th style="padding: 10px; border-bottom: 1px solid #e5e7eb;">é”™è¯¯è¯¦æƒ…</th>
                            </tr>
                        </thead>
                        <tbody id="validationTableBody">
                            <!-- Rows generated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="window.aggregationsPage.closeValidationModal()">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- é”™è¯¯è¯¦æƒ…å¼¹çª— (äºŒçº§) -->
    <div id="errorDetailModal" class="modal-overlay" style="display:none; z-index: 1100;">
        <div class="modal modal-detail" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title">é”™è¯¯è¯¦æƒ…</h2>
                <button class="modal-close" onclick="window.aggregationsPage.closeErrorDetailModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="errorDetailContent" style="white-space: pre-wrap; line-height: 1.6;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="window.aggregationsPage.closeErrorDetailModal()">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- åˆ†é¡µæ§ä»¶ -->
    <div class="pagination" id="pagination" style="display: none;">
        <button id="prevPageBtn" class="pagination-btn" disabled>ä¸Šä¸€é¡µ</button>
        <span id="pageInfo" class="page-info">ç¬¬ 1 é¡µ / å…± 1 é¡µ</span>
        <button id="nextPageBtn" class="pagination-btn" disabled>ä¸‹ä¸€é¡µ</button>
        <div class="page-size-selector">
            æ¯é¡µæ˜¾ç¤º
            <select id="pageSizeSelect">
                <option value="10">10</option>
                <option value="20" selected>20</option>
                <option value="50">50</option>
            </select>
            æ¡
        </div>
    </div>
</div>

<script>
(function() {
    console.log('[Aggregations] é¡µé¢åˆå§‹åŒ–å¼€å§‹');

    // ==================== çŠ¶æ€ç®¡ç† ====================
    const state = {
        currentPage: 1,
        pageSize: 20,
        total: 0,
        sortBy: 'generated_at',
        sortOrder: 'desc',
        filters: {
            taskName: '',
            startDate: null,
            endDate: null
        }
    };

    // ==================== DOM å…ƒç´  ====================
    const elements = {
        loadingIndicator: document.getElementById('loadingIndicator'),
        errorMessage: document.getElementById('errorMessage'),
        tableBody: document.getElementById('aggregationsTableBody'),
        emptyState: document.getElementById('emptyState'),
        pagination: document.getElementById('pagination'),
        pageInfo: document.getElementById('pageInfo'),
        prevPageBtn: document.getElementById('prevPageBtn'),
        nextPageBtn: document.getElementById('nextPageBtn'),
        pageSizeSelect: document.getElementById('pageSizeSelect'),
        refreshBtn: document.getElementById('refreshBtn'),
        taskNameFilter: document.getElementById('taskNameFilter'),
        startDateFilter: document.getElementById('startDateFilter'),
        endDateFilter: document.getElementById('endDateFilter'),
        filterBtn: document.getElementById('filterBtn'),
        resetFilterBtn: document.getElementById('resetFilterBtn')
    };

    // ==================== å·¥å…·å‡½æ•° ====================
    function showLoading() {
        // elements.loadingIndicator.style.display = 'flex';
        elements.errorMessage.style.display = 'none';
        elements.emptyState.style.display = 'none';
        elements.tableBody.innerHTML = `
            <tr>
                <td colspan="5" class="loading-state" style="text-align: center; padding: 40px;">
                    <div class="loading-spinner" style="margin: 0 auto 10px;"></div>
                    <div>åŠ è½½ä¸­...</div>
                </td>
            </tr>
        `;
    }

    function hideLoading() {
        // elements.loadingIndicator.style.display = 'none';
    }

    function showError(message) {
        elements.errorMessage.textContent = message;
        elements.errorMessage.style.display = 'block';
        hideLoading();
    }

    function formatDateTime(dateStr) {
        const date = new Date(dateStr);
        return date.toLocaleString('zh-CN', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    // ==================== API è°ƒç”¨ ====================
    async function fetchAggregations() {
        console.log('[Aggregations] åˆ—è¡¨åŠ è½½å¼€å§‹');
        showLoading();
        try {
            const params = new URLSearchParams({
                page: state.currentPage,
                page_size: state.pageSize,
                sort_by: state.sortBy,
                sort_order: state.sortOrder,
                _t: Date.now() // Prevent caching
            });

            if (state.filters.taskName) {
                params.append('task_name', state.filters.taskName);
            }
            if (state.filters.startDate) {
                params.append('start_date', state.filters.startDate);
            }
            if (state.filters.endDate) {
                params.append('end_date', state.filters.endDate);
            }

            const result = await CommonAPI.get(`/api/aggregations/list?${params.toString()}`);
            hideLoading();

            if (result.success) {
                state.total = result.data.total;
                renderTable(result.data.data);
                updatePagination();
                console.log('[Aggregations] åˆ—è¡¨åŠ è½½å®Œæˆ');
            } else {
                showError(result.error || 'è·å–æ±‡æ€»è¡¨åˆ—è¡¨å¤±è´¥');
            }
        } catch (error) {
            showError('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
        }
    }

    async function downloadAggregation(aggregationId, filename) {
        try {
            const token = localStorage.getItem('mailmerge_token');
            if (!token) {
                alert('è¯·å…ˆç™»å½•');
                return;
            }

            const response = await fetch(`/api/aggregations/${aggregationId}/download`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (!response.ok) {
                if (response.status === 401) {
                    alert('è®¤è¯å¤±è´¥ï¼Œè¯·é‡æ–°ç™»å½•');
                    return;
                }
                throw new Error('ä¸‹è½½å¤±è´¥');
            }

            const contentDisposition = response.headers.get('content-disposition');
            let downloadFilename = 'aggregation.xlsx';
            
            if (contentDisposition) {
                const filenameStarMatch = /filename\*=UTF-8''(.+)/i.exec(contentDisposition);
                if (filenameStarMatch) {
                    downloadFilename = decodeURIComponent(filenameStarMatch[1]);
                } else {
                    const filenameMatch = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/i.exec(contentDisposition);
                    if (filenameMatch && filenameMatch[1]) {
                        downloadFilename = filenameMatch[1].replace(/['"]/g, '');
                    }
                }
            }

            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = downloadFilename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        } catch (error) {
            alert('ä¸‹è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
        }
    }

    async function showValidation(aggregationId) {
        try {
            const result = await CommonAPI.get(`/api/aggregations/${aggregationId}/info`);
            if (!result.success) {
                alert(result.message || 'è·å–æ ¡éªŒä¿¡æ¯å¤±è´¥');
                return;
            }
            
            // result.data is the response body from backend
            // backend returns { success: true, data: { ... } }
            const responseBody = result.data || {};
            
            if (responseBody.success === false) {
                 alert(responseBody.message || 'è·å–æ ¡éªŒä¿¡æ¯å¤±è´¥');
                 return;
            }

            const data = responseBody.data || {};
            const records = data.validation_records || [];
            
            const tbody = document.getElementById('validationTableBody');
            tbody.innerHTML = '';

            if (records.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="padding: 20px; text-align: center; color: #6b7280;">æš‚æ— æ ¡éªŒé”™è¯¯</td></tr>';
            } else {
                records.forEach(rec => {
                    const tr = document.createElement('tr');
                    tr.style.borderBottom = '1px solid #f3f4f6';
                    
                    const teacherDisplay = `${escapeHtml(rec.teacher_name)} (${rec.teacher_id})`;
                    const errorTypeDisplay = rec.error_type === 'MISSING' ? 
                        '<span style="color: #EF4444; background: #FEE2E2; padding: 2px 6px; border-radius: 4px; font-size: 12px;">æœªå¡«å†™</span>' : 
                        '<span style="color: #D97706; background: #FEF3C7; padding: 2px 6px; border-radius: 4px; font-size: 12px;">æ ¼å¼é”™è¯¯</span>';
                    
                    const errorDesc = rec.error_description || '';

                    tr.innerHTML = `
                        <td style="padding: 10px;">${teacherDisplay}</td>
                        <td style="padding: 10px;">${escapeHtml(rec.field_name)}</td>
                        <td style="padding: 10px;">${errorTypeDisplay}</td>
                        <td style="padding: 10px; color: #666; font-size: 13px;">${escapeHtml(errorDesc)}</td>
                    `;
                    tbody.appendChild(tr);
                });
            }
            document.getElementById('validationErrorsModal').style.display = 'flex';
        } catch (err) {
            console.error(err);
            alert('è·å–æ ¡éªŒä¿¡æ¯å¤±è´¥ï¼Œè¯·é‡è¯•');
        }
    }

    function closeValidationModal() {
        document.getElementById('validationErrorsModal').style.display = 'none';
    }
    
    function showErrorDetail(encodedDesc) {
        const desc = decodeURIComponent(encodedDesc);
        document.getElementById('errorDetailContent').textContent = desc;
        document.getElementById('errorDetailModal').style.display = 'flex';
    }
    
    function closeErrorDetailModal() {
        document.getElementById('errorDetailModal').style.display = 'none';
    }

    // ==================== æ¸²æŸ“å‡½æ•° ====================
    function renderTable(aggregations) {
        if (aggregations.length === 0) {
            elements.tableBody.innerHTML = '';
            elements.emptyState.style.display = 'flex';
            elements.pagination.style.display = 'none';
            return;
        }

        elements.emptyState.style.display = 'none';
        
        const rows = aggregations.map(agg => `
            <tr>
                <td class="col-name">${escapeHtml(agg.name)}</td>
                <td class="col-task">${escapeHtml(agg.task_name)}</td>
                <td class="col-time">${formatDateTime(agg.generated_at)}</td>
                <td class="col-count">${agg.record_count !== null && agg.record_count !== undefined ? agg.record_count : '-'}</td>
                <td class="col-validate"><a href="#" onclick="window.aggregationsPage.showValidation(${agg.id}); return false;">${agg.has_validation_issues ? '<span style="color:#D97706;">æœ‰ä¸åˆè§„</span>' : '<span style="color:#059669;">æ­£å¸¸</span>'}</a></td>
                <td class="col-actions">
                    <button class="btn-download" onclick="window.aggregationsPage.handleDownload(${agg.id}, '${escapeHtml(agg.name)}')">
                        <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                            <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
                        </svg>
                        ä¸‹è½½
                    </button>
                </td>
            </tr>
        `).join('');

        elements.tableBody.innerHTML = rows;
    }

    function updatePagination() {
        const totalPages = Math.ceil(state.total / state.pageSize);
        
        if (totalPages <= 1) {
            elements.pagination.style.display = 'none';
            return;
        }

        elements.pagination.style.display = 'flex';
        elements.pageInfo.textContent = `ç¬¬ ${state.currentPage} é¡µ / å…± ${totalPages} é¡µ (å…± ${state.total} æ¡)`;
        elements.prevPageBtn.disabled = state.currentPage === 1;
        elements.nextPageBtn.disabled = state.currentPage === totalPages;
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // ==================== äº‹ä»¶å¤„ç† ====================
    function handleDownload(aggregationId, filename) {
        downloadAggregation(aggregationId, filename);
    }

    function handleSort(sortBy) {
        if (state.sortBy === sortBy) {
            state.sortOrder = state.sortOrder === 'asc' ? 'desc' : 'asc';
        } else {
            state.sortBy = sortBy;
            state.sortOrder = 'desc';
        }
        state.currentPage = 1;
        updateSortUI();
        fetchAggregations();
    }

    function updateSortUI() {
        document.querySelectorAll('.sortable').forEach(th => {
            th.classList.remove('active');
            th.querySelector('.sort-icon').textContent = 'â‡…';
        });

        const activeTh = document.querySelector(`[data-sort="${state.sortBy}"]`);
        if (activeTh) {
            activeTh.classList.add('active');
            activeTh.querySelector('.sort-icon').textContent = state.sortOrder === 'asc' ? 'â–²' : 'â–¼';
        }
    }

    function handleFilter() {
        state.filters.taskName = elements.taskNameFilter.value.trim();
        state.filters.startDate = elements.startDateFilter.value || null;
        state.filters.endDate = elements.endDateFilter.value || null;
        state.currentPage = 1;
        fetchAggregations();
    }

    function handleResetFilter() {
        elements.taskNameFilter.value = '';
        elements.startDateFilter.value = '';
        elements.endDateFilter.value = '';
        state.filters = {
            taskName: '',
            startDate: null,
            endDate: null
        };
        state.currentPage = 1;
        fetchAggregations();
    }

    // ==================== äº‹ä»¶ç»‘å®š ====================
    elements.refreshBtn.addEventListener('click', () => fetchAggregations());
    
    // é¡µé¢å¯è§æ€§å˜åŒ–æ—¶è‡ªåŠ¨åˆ·æ–°
    document.addEventListener('visibilitychange', () => {
        if (!document.hidden) {
            fetchAggregations();
        }
    });

    elements.filterBtn.addEventListener('click', handleFilter);
    elements.resetFilterBtn.addEventListener('click', handleResetFilter);
    if (elements.taskNameFilter) {
        elements.taskNameFilter.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault();
                handleFilter();
            }
        });
    }
    elements.prevPageBtn.addEventListener('click', () => {
        if (state.currentPage > 1) {
            state.currentPage--;
            fetchAggregations();
        }
    });
    elements.nextPageBtn.addEventListener('click', () => {
        const totalPages = Math.ceil(state.total / state.pageSize);
        if (state.currentPage < totalPages) {
            state.currentPage++;
            fetchAggregations();
        }
    });
    elements.pageSizeSelect.addEventListener('change', (e) => {
        state.pageSize = parseInt(e.target.value);
        state.currentPage = 1;
        fetchAggregations();
    });

    // æ’åºç‚¹å‡»äº‹ä»¶
    document.querySelectorAll('.sortable').forEach(th => {
        th.addEventListener('click', () => {
            const sortBy = th.dataset.sort;
            handleSort(sortBy);
        });
    });


    // ==================== å¯¼å‡ºå…¨å±€å‡½æ•° ====================
    window.aggregationsPage = {
        handleDownload: handleDownload,
        showValidation: showValidation,
        closeValidationModal: closeValidationModal,
        showErrorDetail: showErrorDetail,
        closeErrorDetailModal: closeErrorDetailModal
    };

    // ==================== åˆå§‹åŒ– ====================
    (async function init() {
        if (typeof CommonAPI === 'undefined') {
            await new Promise(resolve => setTimeout(resolve, 300));
        }

        await fetchAggregations();

        console.log('[Aggregations] é¡µé¢åˆå§‹åŒ–å®Œæˆ');
    })();
})();
</script>
