<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ³¨å†Œ - é‚®ä»¶æ±‡æ€»ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="/frontend/static/css/base.css">
    <link rel="stylesheet" href="/frontend/static/css/auth.css">
    <style>
        /* æ³¨å†Œå¡ç‰‡æ‰©å¤§å®½åº¦ */
        .auth-card {
            max-width: 500px;
        }
        
        /* ä¸¤åˆ—å¸ƒå±€ */
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }
        
        /* å•åˆ—å¸ƒå±€ï¼ˆç”¨äºå æ»¡æ•´è¡Œçš„å­—æ®µï¼‰ */
        .form-row-full {
            display: block;
        }
        
        @media (max-width: 640px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        /* æ­¥éª¤æ¡æ ·å¼ */
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            position: relative;
            padding: 0 20px;
        }
        
        .step-indicator::before {
            content: '';
            position: absolute;
            top: 15px;
            left: 40px;
            right: 40px;
            height: 2px;
            background: #eee;
            z-index: 0;
        }

        .step-item {
            position: relative;
            z-index: 1;
            text-align: center;
            background: white;
            padding: 0 10px;
        }

        .step-dot {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #eee;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #666;
            margin: 0 auto 8px;
            transition: all 0.3s ease;
        }

        .step-item.active .step-dot {
            background: #007bff;
            color: white;
            box-shadow: 0 0 0 4px rgba(0, 123, 255, 0.2);
        }

        .step-item.completed .step-dot {
            background: #28a745;
            color: white;
        }

        .step-label {
            font-size: 12px;
            color: #999;
        }

        .step-item.active .step-label {
            color: #007bff;
            font-weight: bold;
        }

        /* æ­¥éª¤å†…å®¹åˆ‡æ¢ */
        .step-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .step-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* åº•éƒ¨æŒ‰é’®ç»„ */
        .step-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            gap: 16px;
        }

        .btn-prev {
            background: #f8f9fa;
            color: #333;
            border: 1px solid #ddd;
        }
        
        .btn-prev:hover {
            background: #e2e6ea;
        }

        .btn-next {
            background: #007bff;
            color: white;
            flex: 1;
        }

        .btn-next:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>
    <div class="auth-container">
        <div class="auth-card">
            <!-- å¡ç‰‡å¤´éƒ¨ -->
            <div class="auth-header">
                <div class="auth-logo">ğŸ“§</div>
                <h1 class="auth-title">ç”¨æˆ·æ³¨å†Œ</h1>
                <p class="auth-subtitle">åˆ›å»ºæ‚¨çš„è´¦å·å¼€å§‹ä½¿ç”¨ç³»ç»Ÿ</p>
            </div>

            <!-- æ­¥éª¤æŒ‡ç¤ºå™¨ -->
            <div class="step-indicator">
                <div class="step-item active" data-step="1">
                    <div class="step-dot">1</div>
                    <div class="step-label">åŸºæœ¬ä¿¡æ¯</div>
                </div>
                <div class="step-item" data-step="2">
                    <div class="step-dot">2</div>
                    <div class="step-label">é‚®ç®±éªŒè¯</div>
                </div>
                <div class="step-item" data-step="3">
                    <div class="step-dot">3</div>
                    <div class="step-label">è´¦å·è®¾ç½®</div>
                </div>
            </div>

            <!-- å¡ç‰‡ä¸»ä½“ -->
            <div class="auth-body">
                <form id="registerForm">
                    <!-- æ­¥éª¤ 1ï¼šåŸºæœ¬ä¿¡æ¯ -->
                    <div class="step-content active" id="step1">
                        <div class="form-group">
                            <label class="form-label form-label-required">å·¥å·</label>
                            <input 
                                type="number" 
                                class="auth-input" 
                                id="employee_id" 
                                name="employee_id"
                                placeholder="è¯·è¾“å…¥æ•™èŒå·¥å·"
                                required
                            >
                            <div class="form-error" id="employeeIdError"></div>
                        </div>

                        <div class="form-group">
                            <label class="form-label form-label-required">å§“å</label>
                            <input 
                                type="text" 
                                class="auth-input" 
                                id="name" 
                                name="name"
                                placeholder="è¯·è¾“å…¥çœŸå®å§“å"
                                required
                            >
                            <div class="form-error" id="nameError"></div>
                        </div>

                        <div class="form-group">
                            <label class="form-label form-label-required">æ‰€å±é™¢ç³»</label>
                            <select 
                                class="auth-select" 
                                id="department_id" 
                                name="department_id"
                                required
                            >
                                <option value="">è¯·é€‰æ‹©é™¢ç³»</option>
                            </select>
                            <div class="form-error" id="departmentError"></div>
                        </div>
                    </div>

                    <!-- æ­¥éª¤ 2ï¼šé‚®ç®±éªŒè¯ -->
                    <div class="step-content" id="step2">
                        <div class="form-group">
                            <label class="form-label form-label-required">é‚®ç®±</label>
                            <input 
                                type="email" 
                                class="auth-input" 
                                id="email" 
                                name="email"
                                placeholder="è¯·è¾“å…¥é‚®ç®±åœ°å€"
                                required
                                autocomplete="email"
                            >
                            <div class="form-error" id="emailError"></div>
                        </div>

                        <div class="form-group">
                            <label class="form-label form-label-required">é‚®ç®±æˆæƒç </label>
                            <input 
                                type="password" 
                                class="auth-input" 
                                id="mail_auth_code" 
                                name="mail_auth_code"
                                placeholder="SMTP/IMAPæˆæƒç "
                                required
                                autocomplete="off"
                            >
                            <div class="form-error" id="mailAuthCodeError"></div>
                            <div class="form-hint" style="font-size: 12px; color: #666; margin-top: 4px;">
                                ç”¨äºç³»ç»Ÿè‡ªåŠ¨å‘é€å’Œæ¥æ”¶é‚®ä»¶ï¼Œè¯·åœ¨é‚®ç®±è®¾ç½®ä¸­å¼€å¯SMTP/IMAPæœåŠ¡è·å–ã€‚
                            </div>
                        </div>
                    </div>

                    <!-- æ­¥éª¤ 3ï¼šè´¦å·è®¾ç½® -->
                    <div class="step-content" id="step3">
                        <div class="form-group">
                            <label class="form-label form-label-required">ç”¨æˆ·å</label>
                            <input 
                                type="text" 
                                class="auth-input" 
                                id="username" 
                                name="username"
                                placeholder="4-20ä½å­—æ¯ã€æ•°å­—æˆ–ä¸‹åˆ’çº¿"
                                required
                                autocomplete="username"
                            >
                            <div class="form-error" id="usernameError"></div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">æ‰‹æœºå·</label>
                            <input 
                                type="tel" 
                                class="auth-input" 
                                id="phone" 
                                name="phone"
                                placeholder="è¯·è¾“å…¥æ‰‹æœºå·ï¼ˆé€‰å¡«ï¼‰"
                                autocomplete="tel"
                            >
                            <div class="form-error" id="phoneError"></div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label form-label-required">å¯†ç </label>
                                <input 
                                    type="password" 
                                    class="auth-input" 
                                    id="password" 
                                    name="password"
                                    placeholder="è‡³å°‘6ä½å­—ç¬¦"
                                    required
                                    autocomplete="new-password"
                                >
                                <div class="form-error" id="passwordError"></div>
                            </div>

                            <div class="form-group">
                                <label class="form-label form-label-required">ç¡®è®¤å¯†ç </label>
                                <input 
                                    type="password" 
                                    class="auth-input" 
                                    id="confirmPassword" 
                                    name="confirmPassword"
                                    placeholder="è¯·å†æ¬¡è¾“å…¥å¯†ç "
                                    required
                                    autocomplete="new-password"
                                >
                                <div class="form-error" id="confirmPasswordError"></div>
                            </div>
                        </div>
                    </div>

                    <!-- æŒ‰é’®ç»„ -->
                    <div class="step-actions">
                        <button type="button" class="auth-submit btn-prev" id="prevBtn" style="display: none;">ä¸Šä¸€æ­¥</button>
                        <button type="button" class="auth-submit btn-next" id="nextBtn">ä¸‹ä¸€æ­¥</button>
                        <button type="submit" class="auth-submit btn-next" id="submitBtn" style="display: none;">æ³¨å†Œ</button>
                    </div>
                </form>

                <!-- åº•éƒ¨é“¾æ¥ -->
                <div class="auth-footer">
                    å·²æœ‰è´¦å·ï¼Ÿ
                    <a href="/frontend/login.html" class="auth-link">ç«‹å³ç™»å½•</a>
                </div>
            </div>
        </div>
    </div>

    <!-- å¼•å…¥ JS æ–‡ä»¶ -->
    <script src="/frontend/static/js/utils.js"></script>
    <script src="/frontend/static/js/api/common.js"></script>
    <script src="/frontend/static/js/api/auth.js"></script>
    
    <script>
        // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
        if (Utils.isAuthenticated()) {
            window.location.href = '/frontend/index.html';
        }

        // åŠ è½½é™¢ç³»åˆ—è¡¨
        async function loadDepartments() {
            const result = await AuthAPI.getDepartments();
            
            if (result.success) {
                const select = document.getElementById('department_id');
                result.departments.forEach(dept => {
                    const option = document.createElement('option');
                    option.value = dept.id;
                    option.textContent = dept.name;
                    select.appendChild(option);
                });
            } else {
                console.error('åŠ è½½é™¢ç³»åˆ—è¡¨å¤±è´¥:', result.message);
            }
        }

        // é¡µé¢åŠ è½½æ—¶è·å–é™¢ç³»åˆ—è¡¨
        loadDepartments();

        // æ­¥éª¤ç®¡ç†
        let currentStep = 1;
        const totalSteps = 3;

        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const submitBtn = document.getElementById('submitBtn');

        function updateStepUI() {
            // æ›´æ–°æ­¥éª¤æŒ‡ç¤ºå™¨
            document.querySelectorAll('.step-item').forEach(item => {
                const step = parseInt(item.dataset.step);
                item.classList.remove('active', 'completed');
                if (step === currentStep) {
                    item.classList.add('active');
                } else if (step < currentStep) {
                    item.classList.add('completed');
                }
            });

            // æ˜¾ç¤ºå½“å‰æ­¥éª¤å†…å®¹
            document.querySelectorAll('.step-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`step${currentStep}`).classList.add('active');

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            if (currentStep === 1) {
                prevBtn.style.display = 'none';
                nextBtn.style.display = 'block';
                submitBtn.style.display = 'none';
            } else if (currentStep === totalSteps) {
                prevBtn.style.display = 'block';
                nextBtn.style.display = 'none';
                submitBtn.style.display = 'block';
            } else {
                prevBtn.style.display = 'block';
                nextBtn.style.display = 'block';
                submitBtn.style.display = 'none';
            }
        }

        // éªŒè¯å½“å‰æ­¥éª¤
        function validateStep(step) {
            let isValid = true;
            // æ¸…é™¤å½“å‰æ­¥éª¤çš„é”™è¯¯æç¤º
            const currentStepEl = document.getElementById(`step${step}`);
            currentStepEl.querySelectorAll('.form-error').forEach(el => el.textContent = '');

            if (step === 1) {
                // éªŒè¯å·¥å·
                const employeeId = document.getElementById('employee_id').value.trim();
                if (!employeeId) {
                    document.getElementById('employeeIdError').textContent = 'è¯·è¾“å…¥å·¥å·';
                    isValid = false;
                } else if (parseInt(employeeId) <= 0) {
                    document.getElementById('employeeIdError').textContent = 'å·¥å·å¿…é¡»æ˜¯æ­£æ•´æ•°';
                    isValid = false;
                }

                // éªŒè¯å§“å
                const name = document.getElementById('name').value.trim();
                if (!name) {
                    document.getElementById('nameError').textContent = 'è¯·è¾“å…¥å§“å';
                    isValid = false;
                }

                // éªŒè¯é™¢ç³»
                const departmentId = document.getElementById('department_id').value;
                if (!departmentId) {
                    document.getElementById('departmentError').textContent = 'è¯·é€‰æ‹©é™¢ç³»';
                    isValid = false;
                }
            } else if (step === 2) {
                // éªŒè¯é‚®ç®±
                const email = document.getElementById('email').value.trim();
                if (!email) {
                    document.getElementById('emailError').textContent = 'è¯·è¾“å…¥é‚®ç®±';
                    isValid = false;
                } else if (!Utils.validateEmail(email)) {
                    document.getElementById('emailError').textContent = 'é‚®ç®±æ ¼å¼ä¸æ­£ç¡®';
                    isValid = false;
                }

                // éªŒè¯æˆæƒç 
                const mailAuthCode = document.getElementById('mail_auth_code').value.trim();
                if (!mailAuthCode) {
                    document.getElementById('mailAuthCodeError').textContent = 'è¯·è¾“å…¥é‚®ç®±æˆæƒç ';
                    isValid = false;
                }
            } else if (step === 3) {
                // éªŒè¯ç”¨æˆ·å
                const username = document.getElementById('username').value.trim();
                if (!username) {
                    document.getElementById('usernameError').textContent = 'è¯·è¾“å…¥ç”¨æˆ·å';
                    isValid = false;
                } else if (!/^[a-zA-Z0-9_]{4,20}$/.test(username)) {
                    document.getElementById('usernameError').textContent = 'ç”¨æˆ·åå¿…é¡»æ˜¯4-20ä½å­—æ¯ã€æ•°å­—æˆ–ä¸‹åˆ’çº¿';
                    isValid = false;
                }

                // éªŒè¯æ‰‹æœºå·
                const phone = document.getElementById('phone').value.trim();
                if (phone && !Utils.validatePhone(phone)) {
                    document.getElementById('phoneError').textContent = 'æ‰‹æœºå·æ ¼å¼ä¸æ­£ç¡®';
                    isValid = false;
                }

                // éªŒè¯å¯†ç 
                const password = document.getElementById('password').value;
                if (!password) {
                    document.getElementById('passwordError').textContent = 'è¯·è¾“å…¥å¯†ç ';
                    isValid = false;
                } else if (password.length < 6) {
                    document.getElementById('passwordError').textContent = 'å¯†ç è‡³å°‘6ä½å­—ç¬¦';
                    isValid = false;
                }

                // éªŒè¯ç¡®è®¤å¯†ç 
                const confirmPassword = document.getElementById('confirmPassword').value;
                if (!confirmPassword) {
                    document.getElementById('confirmPasswordError').textContent = 'è¯·ç¡®è®¤å¯†ç ';
                    isValid = false;
                } else if (password !== confirmPassword) {
                    document.getElementById('confirmPasswordError').textContent = 'ä¸¤æ¬¡å¯†ç è¾“å…¥ä¸ä¸€è‡´';
                    isValid = false;
                }
            }

            return isValid;
        }

        // æŒ‰é’®äº‹ä»¶ç›‘å¬
        nextBtn.addEventListener('click', () => {
            if (validateStep(currentStep)) {
                currentStep++;
                updateStepUI();
            }
        });

        prevBtn.addEventListener('click', () => {
            currentStep--;
            updateStepUI();
        });

        // è¡¨å•æäº¤å¤„ç†
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            // éªŒè¯æœ€åä¸€æ­¥
            if (!validateStep(currentStep)) {
                return;
            }

            // è·å–è¡¨å•æ•°æ®
            const formData = {
                employee_id: parseInt(document.getElementById('employee_id').value.trim()),
                name: document.getElementById('name').value.trim(),
                department_id: parseInt(document.getElementById('department_id').value),
                username: document.getElementById('username').value.trim(),
                email: document.getElementById('email').value.trim(),
                mail_auth_code: document.getElementById('mail_auth_code').value.trim(),
                phone: document.getElementById('phone').value.trim() || null,
                password: document.getElementById('password').value,
            };

            // ç¦ç”¨æäº¤æŒ‰é’®
            submitBtn.disabled = true;
            submitBtn.textContent = 'æ³¨å†Œä¸­...';

            try {
                // è°ƒç”¨æ³¨å†Œ API
                const result = await AuthAPI.register(formData);

                if (result.success) {
                    alert('æ³¨å†ŒæˆåŠŸï¼å³å°†è·³è½¬åˆ°ç™»å½•é¡µé¢');
                    // è·³è½¬åˆ°ç™»å½•é¡µ
                    setTimeout(() => {
                        window.location.href = '/frontend/login.html';
                    }, 1000);
                } else {
                    // æ˜¾ç¤ºå‹å¥½çš„é”™è¯¯ä¿¡æ¯
                    const errorMsg = result.message || 'æ³¨å†Œå¤±è´¥ï¼Œè¯·æ£€æŸ¥è¾“å…¥ä¿¡æ¯';
                    alert(errorMsg);
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'æ³¨å†Œ';
                }
            } catch (error) {
                console.error('æ³¨å†Œå¤±è´¥:', error);
                alert('ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•');
                submitBtn.disabled = false;
                submitBtn.textContent = 'æ³¨å†Œ';
            }
        });
    </script>
</body>
</html>
