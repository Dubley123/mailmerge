<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>邮件汇总系统</title>
    <link rel="stylesheet" href="/frontend/static/css/base.css">
    <link rel="stylesheet" href="/frontend/static/css/layout.css">
    <link rel="stylesheet" href="/frontend/static/css/components.css">
</head>
<body>
    <!-- 主容器：左侧导航栏 + 右侧内容区 -->
    <div class="main-container">
        <!-- 左侧导航栏 -->
        <div id="sidebar-container"></div>

        <!-- 右侧内容区 -->
        <div class="content-wrapper">
            <!-- 顶部横幅 -->
            <div id="header-container"></div>

            <!-- 主内容区 - 子页面加载容器 -->
            <main class="main-content">
                <div id="app">
                    <!-- 子页面内容将动态加载到这里 -->
                    <div style="text-align: center; padding: 60px 20px;">
                        <div style="font-size: 48px; margin-bottom: 16px;">⏳</div>
                        <div style="color: #6B7280;">加载中...</div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- 引入 JS 文件 -->
    <script src="/frontend/static/js/utils.js?v=3"></script>
    <script src="/frontend/static/js/api/common.js?v=3"></script>
    <script src="/frontend/static/js/api/auth.js?v=3"></script>
    <script src="/frontend/static/js/navigation.js?v=3"></script>

    <script>
        // 全局更新用户信息函数
        window.updateUserInfo = function() {
            const user = Utils.getUser();
            if (!user) return;
            
            // 更新header
            const headerUserName = document.getElementById('headerUserName');
            if (headerUserName) {
                headerUserName.textContent = user.name || '用户';
            }
            
            // 更新sidebar
            const sidebarUserName = document.getElementById('sidebarUserName');
            const sidebarUserDept = document.getElementById('sidebarUserDept');
            if (sidebarUserName) {
                sidebarUserName.textContent = user.name || '用户';
            }
            if (sidebarUserDept) {
                sidebarUserDept.textContent = user.department || '未设置院系';
            }
        };

        // 检查登录状态
        async function checkAuth() {
            if (!Utils.isAuthenticated()) {
                // 未登录，跳转到登录页
                window.location.href = '/frontend/login.html';
                return false;
            }

            // 验证 token 是否有效
            const result = await AuthAPI.verifyToken();
            if (!result.success) {
                // Token 无效，跳转到登录页
                window.location.href = '/frontend/login.html';
                return false;
            }

            return true;
        }

        // 加载组件
        async function loadComponent(containerId, componentPath) {
            try {
                const response = await fetch(componentPath);
                if (!response.ok) {
                    throw new Error(`加载组件失败: ${componentPath}`);
                }
                const html = await response.text();
                const container = document.getElementById(containerId);
                if (container) {
                    container.innerHTML = html;
                    
                    // 执行组件中的脚本
                    const scripts = container.querySelectorAll('script');
                    scripts.forEach((script) => {
                        const newScript = document.createElement('script');
                        if (script.src) {
                            newScript.src = script.src;
                        } else {
                            newScript.textContent = script.textContent;
                        }
                        script.parentNode.replaceChild(newScript, script);
                    });
                }
            } catch (error) {
                console.error('加载组件失败:', error);
            }
        }

        // 初始化页面
        async function init() {
            // 检查登录状态（会调用verifyToken更新用户信息）
            const isAuth = await checkAuth();
            if (!isAuth) return;

            // 加载侧边栏组件
            await loadComponent('sidebar-container', '/frontend/components/sidebar.html');

            // 加载顶部横幅组件
            await loadComponent('header-container', '/frontend/components/header.html');

            // 更新用户信息（此时localStorage中已有用户数据）
            updateUserInfo();

            // 初始化导航系统
            Navigation.init();
        }

        // 页面加载完成后初始化
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
